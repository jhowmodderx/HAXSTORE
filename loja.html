<!DOCTYPE html>
<html lang="pt-BR">
<cabeça>
    <meta charset="UTF-8" />
    <meta name="viewport" content="largura=largura-do-dispositivo, escala-inicial=1.0"/>
    <title>LOJA HAX</title>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-storage-compat.js"></script> <estilo>
        /* Redefinir e base */
        * { margem: 0; preenchimento: 0; tamanho da caixa: caixa de borda; }
        corpo { família da fonte: Arial, sem serifa; cor de fundo: #0c0c0c; cor: #fff; altura da linha: 1,6; }

        /* Cabeçalho */
        cabeçalho {
            exibição: flexível;
            justificar-conteúdo: espaço-entre;
            alinhar-itens: centro;
            cor de fundo: #111;
            preenchimento: 15px 20px;
            borda inferior: 2px sólido #e50914;
        }

        .logo { cor: #e50914; tamanho da fonte: 22px; espessura da fonte: negrito; }

        .botões de cabeçalho {
            exibição: flexível;
            lacuna: 10px; /* Espaçamento entre os botões */
        }

        .botão-discord, .botão-painel-admin, .botão-logout {
            fundo: transparente;
            borda: 2px sólido #e50914;
            cor: #e50914;
            preenchimento: 8px 16px;
            raio da borda: 6px;
            cursor: ponteiro;
            transição: 0,3s;
        }

        .botão-discord:hover, .botão-do-painel-admin:hover, .botão-logout:hover {
            cor de fundo: #e50914;
            cor: branco;
        }

        /* Bandeira */
        .banner {
            altura: 250px;
            background: url('') centro sem repetição centro; /* Imagem do banner */
            tamanho-de-fundo: capa;
            exibição: flexível;
            alinhar-itens: centro;
            justificar-conteúdo: centro;
            alinhamento de texto: centro;
        }

        .banner h2 {
            cor de fundo: rgba(0, 0, 0, 0.6);
            borda: 2px sólido #e50914;
            cor: #e50914;
            preenchimento: 12px 24px;
            raio da borda: 8px;
            tamanho da fonte: 24px;
            espessura da fonte: negrito;
        }

        /* Conteúdo principal */
        .contente {
            preenchimento: 30px 20px;
            largura máxima: 900px;
            margem: 0 auto;
        }

        /* Marca de destaque */
        .marcação {
            exibição: bloco embutido;
            cor de fundo: #e50914;
            cor: branco;
            preenchimento: 4px 10px;
            raio da borda: 4px;
            tamanho da fonte: 12px;
            text-transform: maiúsculas;
            margem inferior: 10px;
        }

        /* Item do produto */
        .produto-item {
            cor de fundo: #1a1a1a;
            borda: 1px sólido #222;
            preenchimento: 20px;
            margem inferior: 20px;
            raio da borda: 8px;
            posição: relativa;
        }

        .produto-titulo { tamanho da fonte: 28px; espessura da fonte: negrito; margem: 10px 0; cor: #e50914;}
        .produto-desc { cor: #ccc; margem inferior: 15px; }

        .precos { margem inferior: 15px; }
        .preco-antigo { decoração-de-texto: linha-através; cor: #888; tamanho-da-fonte: 16px; margem-direita: 10px; }
        .preco-atual { cor: #0f0; tamanho da fonte: 28px; peso da fonte: negrito; } /* Preço atual em verde */

        .btn-comprar {
            cor de fundo: #e50914;
            cor: branco;
            borda: nenhuma;
            preenchimento: 12px 24px;
            tamanho da fonte: 16px;
            raio da borda: 6px;
            cursor: ponteiro;
            transição: 0,3s;
        }

        .btn-comprar:hover {
            cor de fundo: #b20710;
        }

        /* Botões de Admin no produto (só aparecem para admin) */
        .btn-delete-produto {
            cor de fundo: #cc0000;
            cor: branco;
            borda: nenhuma;
            preenchimento: 5px 10px;
            raio da borda: 4px;
            cursor: ponteiro;
            posição: absoluta;
            topo: 10px;
            direita: 10px;
            tamanho da fonte: 12px;
            transição: 0,2s;
        }
        .btn-delete-produto:hover { cor de fundo: #990000; }

        .btn-edit-produto {
            cor de fundo: #007bff;
            cor: branco;
            borda: nenhuma;
            preenchimento: 5px 10px;
            raio da borda: 4px;
            cursor: ponteiro;
            posição: absoluta;
            topo: 10px;
            direita: 70px; /* Ajuste para não sobrepor ou excluir */
            tamanho da fonte: 12px;
            transição: 0,2s;
        }
        .btn-edit-produto:hover { cor de fundo: #0056b3; }


        /* Rodapé */
        rodapé {
            cor de fundo: #111;
            alinhamento de texto: centro;
            preenchimento: 15px;
            cor: #777;
            margem superior: 40px;
            tamanho da fonte: 14px;
        }

        /* Base de modais */
        .modal {
            exibição: nenhum; /* Escondido por padrão */
            posição: fixa;
            índice z: 1000;
            esquerda: 0; topo: 0;
            largura: 100%; altura: 100%;
            cor de fundo: rgba(0, 0, 0, 0.8);
            justificar-conteúdo: centro;
            alinhar-itens: centro;
            estouro: automático; /* Para modais altos em telas pequenas */
        }

        .modal-conteúdo {
            cor de fundo: #111;
            preenchimento: 25px;
            raio da borda: 10px;
            alinhamento de texto: centro;
            largura: 90%;
            largura máxima: 450px; /* Largura padrão */
            borda: 2px sólido #e50914; /* Borda vermelha para modal de compra */
            posição: relativa;
            animação: fadeIn 0,3s de suavização;
        }

        .modal-content.admin-modal {
            largura máxima: 700px; /* Mais largo para o painel de administração */
            borda: 2px sólido #0f0; /* Borda verde para o modal admin */
        }

        .modal-content h3 {
            cor: #e50914;
            margem inferior: 20px;
            tamanho da fonte: 24px;
        }
        .modal-content.admin-modal h3 {
            cor: #0f0; /* Título do modal admin verde */
        }

        .pix-chave {
            cor de fundo: #222;
            preenchimento: 12px;
            raio da borda: 6px;
            tamanho da fonte: 16px;
            quebra de linha: quebra de palavra; /* Quebra texto longo */
            margem inferior: 20px;
            borda: 1px sólido #e50914;
        }

        .btn-confirmar {
            cor de fundo: #e50914;
            borda: nenhuma;
            cor: branco;
            preenchimento: 12px 25px;
            raio da borda: 6px;
            cursor: ponteiro;
            tamanho da fonte: 16px;
            transição: 0,3s;
            margem superior: 10px; /* Margem adicionada para o botão de upload */
        }
        .btn-confirmar:hover { cor de fundo: #b20710; }

        .mensagem-final {
            margem superior: 25px;
            cor: #0f0;
            espessura da fonte: negrito;
            tamanho da fonte: 18px;
            exibição: nenhuma;
        }

        .botão de fechar {
            posição: absoluta;
            topo: 10px;
            direita: 20px;
            cor: #aaa;
            tamanho da fonte: 30px;
            espessura da fonte: negrito;
            cursor: ponteiro;
            transição: 0,2s;
        }
        .botão-fechar:passar o mouse, .botão-fechar:foco {
            cor: #fff;
        }

        /* Estilos de Administração (dentro do modal) */
        .admin-tab-content h4 {
            cor: #eee;
            margem superior: 25px;
            margem inferior: 15px;
            tamanho da fonte: 20px;
            borda inferior: 1px sólido #333;
            preenchimento inferior: 5px;
        }

        .admin-section entrada[tipo="texto"],
        .admin-section entrada[tipo="número"],
        .admin-section textarea {
            largura: calc(100% - 20px);
            preenchimento: 10px;
            margem inferior: 10px;
            cor de fundo: #222;
            borda: 1px sólido #333;
            cor: #fff;
            raio da borda: 4px;
            tamanho da fonte: 15px;
        }

        botão .admin-section {
            cor de fundo: #0f0; /* Botão verde */
            cor: #111;
            borda: nenhuma;
            preenchimento: 10px 20px;
            raio da borda: 5px;
            cursor: ponteiro;
            margem direita: 10px;
            transição: 0,3s;
            tamanho da fonte: 15px;
        }

        .botão de seção de administração: passe o mouse {
            cor de fundo: #00cc00;
        }

        .lista-de-produtos-do-admin, .lista-de-avisos-do-admin, #lista-de-pagamentos-pendentes, #lista-de-pagamentos-processados, #lista-de-logs {
            margem superior: 20px;
            altura máxima: 250px; /* Limite de altura para rolagem */
            estouro-y: automático; /* Adiciona barra de rolagem se necessário */
            preenchimento à direita: 10px; /* Espaço para a barra de rolagem */
            borda superior: 1px sólido #333;
            preenchimento superior: 15px;
        }

        .admin-produto-item, .aviso-item {
            exibição: flexível;
            justificar-conteúdo: espaço-entre;
            alinhar-itens: centro;
            cor de fundo: #222;
            preenchimento: 12px;
            raio da borda: 5px;
            margem inferior: 10px;
            borda: 1px sólido #333;
        }

        .admin-produto-item span, .warning-item span {
            flex-grow: 1;
            alinhamento de texto: esquerda;
            tamanho da fonte: 15px;
        }

        .botão admin-product-item, .botão warning-item {
            margem esquerda: 10px;
            preenchimento: 5px 10px;
            tamanho da fonte: 13px;
            flex-encolhimento: 0;
        }

        .mensagem-de-aviso-do-admin {
            cor de fundo: #e50914;
            cor: branco;
            preenchimento: 10px;
            raio da borda: 5px;
            margem inferior: 20px;
            alinhamento de texto: centro;
            espessura da fonte: negrito;
            tamanho da fonte: 16px;
        }

        /* Estilos para as abas de administração */
        .admin-guias {
            exibição: flexível;
            margem inferior: 20px;
            borda inferior: 1px sólido #0f0;
            estouro-x: automático; /* Permite rolagem horizontal se muitas abas */
        }

        .botão-tabulação-admin {
            cor de fundo: #333;
            cor: #0f0;
            preenchimento: 10px 15px;
            borda: nenhuma;
            cursor: ponteiro;
            raio-superior-esquerdo-da-borda: 8px;
            raio-superior-direito-da-borda: 8px;
            margem direita: 5px;
            transição: cor de fundo 0,3s, cor 0,3s;
            flex-encolher: 0; /* Evita que os botões encolham */
        }

        .admin-tab-button.ativo {
            cor de fundo: #0f0;
            cor: #111;
        }

        .admin-tab-content {
            exibição: nenhuma;
            alinhamento de texto: esquerda;
            preenchimento superior: 15px; /* Espaço após as abas */
        }

        .admin-tab-content.ativo {
            exibir: bloco;
        }

        /* Animação para modal */
        @keyframes fadeIn {
            de { opacidade: 0; transformação: escala(0,9); }
            para { opacidade: 1; transformar: escala(1); }
        }
    </estilo>
</cabeçalho>
<corpo>

    <cabeçalho>
        <div class="logo">LOJA HAX</div>
        <div class="botões-de-cabeçalho">
            <button class="discord-btn" onclick="window.open('https://discord.gg/gJ79TUn6Bb', '_blank')">Entrar no Discord</button>
            <button id="adminPanelBtn" class="admin-panel-btn" style="display: none;">Painel de Administração</button>
            <button id="logoutBtn" class="logout-btn" style="display: none;">Sair</button>
        </div>
    </cabeçalho>

    <div class="banner">
        <h2>Bem-vindo à HAX STORE!</h2>
    </div>

    <div class="content">
        <div id="contêiner-de-avisos"></div>
        <div id="produtos-container"></div>
    </div>

    <rodapé>
        &cópia; LOJA HAX 2025. Todos os direitos reservados.
    </rodapé>

    <div class="modal" id="pixModal">
        <div class="modal-content" id="pixModalContent">
            <span class="close-button" onclick="closePixModal()">×</span>
            <h3>Pagamento via PIX</h3>
            <p>Escaneie o QR Code ou use a chave PIX abaixo:</p>
            <div class="pix-key" id="pixChave"></div>
            
            <div style="margem superior: 20px; borda superior: 1px sólido #333; preenchimento superior: 15px;">
                <h4>Anexar Comprovante</h4>
                <input type="file" id="comprovanteFile" accept="image/*,application/pdf" style="margin-bottom: 10px; color: #fff;">
                <button class="btn-confirmar" onclick="uploadComprovante()">Enviar Comprovante</button>
            </div>

            <button class="btn-confirmar" onclick="confirmarPagamento()">Já realizei o pagamento (apenas para avisar)</button>
            <div class="mensagem-final" id="mensagemFinal">HAX STORE - ENVIE O COMPROVANTE NO TICKET DO DISCORD!</div>
        </div>
    </div>

    <div class="modal" id="adminModal">
        <div class="modal-content admin-modal">
            <span class="close-button" onclick="closeAdminModal()">×</span>
            <h3>Painel de Administração</h3>

            <div class="tabs-admin">
                <button class="admin-tab-button active" onclick="openAdminTab(event, 'manage-products')">Gerenciar Produtos</button>
                <button class="admin-tab-button" onclick="openAdminTab(event, 'manage-warnings')">Gerenciar Avisos</button>
                <button class="admin-tab-button" onclick="openAdminTab(event, 'manage-pix')">Configurar PIX</button>
                <button class="admin-tab-button" onclick="openAdminTab(event, 'manage-payments')">Gerenciar Pagamentos</button>
                <button class="admin-tab-button" onclick="openAdminTab(event, 'admin-logs')">Registros de Atividade</button>
            </div>

            <div id="manage-products" class="admin-tab-content seção de administração ativa">
                <h4>Adicionar/Editar Produto</h4>
                <tipo de entrada="oculto" id="productIdToEdit">
                <input type="text" id="productTitle" placeholder="Título do Produto" required>
                <textarea id="productDesc" placeholder="Descrição do Produto" rows="3"></textarea>
                <input type="number" id="productOldPrice" placeholder="Preço Antigo (Ex: 30.00)" step="0.01">
                <input type="number" id="productNewPrice" placeholder="Preço Atual (Ex: 10,00)" step="0,01" obrigatório>
                <button onclick="saveProduct()">Salvar Produto</button>
                <button onclick="clearProductForm()">Limpar Formulário</button>

                <h4>Produtos Existentes</h4>
                <div id="lista-de-produtos-do-admin"></div>
            </div>

            <div id="gerenciar-avisos" class="conteúdo-da-guia-administrador seção-administradora">
                <h4>Gerenciar Avisos</h4>
                <input type="text" id="warningMessage" placeholder="Nova mensagem de aviso">
                <button onclick="addWarning()">Adicionar Aviso</button>
                <div id="lista-de-avisos-do-admin"></div>
            </div>

            <div id="manage-pix" class="admin-tab-content admin-section">
                <h4>Chave PIX Atual</h4>
                <input type="text" id="currentPixKey" placeholder="Chave PIX atual" somente leitura>
                <h4>Nova Chave PIX</h4>
                <input type="text" id="newPixKey" placeholder="Nova Chave PIX">
                <button onclick="updatePixKey()">Salvar Chave PIX</button>
            </div>

            <div id="gerenciar-pagamentos" class="admin-tab-content admin-section">
                <h4>Solicitações de Pagamento Pendentes</h4>
                <div id="lista-de-pagamentos-pendentes">
                    </div>
                <h4>Histórico de Pagamentos Confirmados/Rejeitados</h4>
                <div id="lista-de-pagamentos-processados" style="altura-máx.: 200px; overflow-y: auto;">
                    </div>
            </div>

            <div id="admin-logs" class="admin-tab-content admin-section">
                <h4>Registros Recentes</h4>
                <div id="logs-list" style="altura-máx.: 400px; overflow-y: auto; alinhamento-de-texto: esquerda;">
                    </div>
            </div>
        </div>
    </div>

    <script>
        // --- Configuração do Firebase ---
        // ATENÇÃO: Verifique se estas são suas chaves corretas!
        // As chaves abaixo são exemplos e DEVEM ser excelentes pelo seu projeto Firebase.
        const firebaseConfig = {
            apiKey: "AIzaSyAx5VNBlcPXveA1xawirSjRVWDNaKdNRmc", // Substitua sua API Key do Firebase
            authDomain: "haxstore-a250a.firebaseapp.com", // Substituição pelo seu Auth Domain
            projectId: "haxstore-a250a", // Substitui pelo seu ID do projeto
            storageBucket: "haxstore-a250a.appspot.com", // Substituição pelo seu Storage Bucket
            messingSenderId: "39538757064", // Substitua pelo seu Messaging Sender ID
            appId: "1:39538757064:web:7f45d2cba626b6333ac4fd", // Substitui pelo seu ID do aplicativo
            mediçãoId: "G-3D42M9L1HF" // Substitui pelo seu ID de medição (se você estiver usando o Analytics)
        };

        // Inicializar o Firebase
        firebase.initializeApp(firebaseConfig);
        const banco de dados = firebase.firestore(); // Cria uma referência ao seu banco de dados Firestore
        armazenamento const = firebase.storage(); // Crie uma referência ao seu Firebase Storage

        // --- Referências aos elementos DOM ---
        const productsContainer = document.getElementById('produtos-container');
        const adminPanelBtn = document.getElementById('adminPanelBtn');
        const logoutBtn = document.getElementById('logoutBtn');
        const adminModal = document.getElementById('adminModal');
        const adminProductsList = document.getElementById('admin-products-list');
        const warningsContainer = document.getElementById('warnings-container');
        const adminWarningsList = document.getElementById('lista-de-avisos-de-admin');
        const pixChaveDisplay = document.getElementById('pixChave');
        const newPixKeyInput = document.getElementById('newPixKey');
        const currentPixKeyDisplay = document.getElementById('currentPixKey');

        // Novas referências DOM
        const comprovanteFileInput = document.getElementById('comprovanteFile');
        const pendingPaymentsList = document.getElementById('lista-de-pagamentos-pendentes');
        const processedPaymentsList = document.getElementById('lista-de-pagamentos-processados');
        const logsList = document.getElementById('lista de logs');

        // --- Chaves para o localStorage (CORRESPONDENDO AO INDEX.HTML) ---
        // Estas chaves devem ser as mesmas usadas no seu arquivo index.html
        const LS_IS_ADMIN_KEY = 'éAdmin';
        const LS_LOGGED_USER_KEY = 'usuário conectado';

        função checkAdminStatus() {
            retornar localStorage.getItem(LS_IS_ADMIN_KEY) === 'verdadeiro';
        }

        função checkLoggedInStatus() {
            retornar localStorage.getItem(LS_LOGGED_USER_KEY) !== nulo;
        }

        // --- Funções de Inicialização ---
        documento.addEventListener('DOMContentLoaded', () => {
            se (!checkLoggedInStatus()) {
                window.location.href = 'index.html'; // Redireciona para o login se não estiver logado
                retornar;
            }

            const isAdmin = checkAdminStatus();
            se (éAdmin) {
                adminPanelBtn.style.display = 'bloco';
            } outro {
                adminPanelBtn.style.display = 'nenhum';
            }
            logoutBtn.style.display = 'bloco';
        });

        // --- Funções de Modal de Compra (PIX) ---
        // Função para abrir o modal de compra (renomeada para melhor esclarecer)
        função comprarAgora() {
            se (!checkLoggedInStatus()) {
                alert('Você precisa estar logado para realizar uma compra.');
                janela.localização.href = 'index.html';
                retornar;
            }
            document.getElementById('pixModal').style.display = 'flex';
            document.getElementById('mensagemFinal').style.display = "nenhum";
            // Limpa a entrada do arquivo caso o usuário abra e feche várias vezes
            comprovanteFileInput.value = '';
        }

        função closePixModal() {
            document.getElementById('pixModal').style.display = 'nenhum';
            document.getElementById('mensagemFinal').style.display = "nenhum";
        }

        função confirmarPagamento() {
            const mensagem = document.getElementById('mensagemFinal');
            mensagem.style.display = 'bloco';
            // Esta função agora serve apenas como um aviso adicional ao usuário
            // o comprovante de fato é enviado pela função `uploadComprovante`
        }

        // --- Funções de Upload de Comprovante ---
        função assíncrona uploadComprovante() {
            se (!checkLoggedInStatus()) {
                alert('Você precisa estar logado para enviar um comprovante.');
                retornar;
            }

            const file = comprovanteFileInput.files[0];
            se (!arquivo) {
                alert('Por favor, selecione um arquivo de comprovante.');
                retornar;
            }

            const currentUser = localStorage.getItem(LS_LOGGED_USER_KEY);
            const userId = currentUser ? JSON.parse(currentUser).uid : 'anônimo';
            const nome_do_usuário = usuárioatual? JSON.parse(currentUser).username : 'Usuário Desconhecido';
            
            const fileName = `${Date.now()}_${file.name}`;
            const storageRef = storage.ref(`comprovantes/${userId}/${fileName}`);
            const uploadTask = storageRef.put(arquivo);

            tentar {
                const loadingMessage = document.createElement('p');
                loadingMessage.textContent = 'Enviando confirmação...';
                carregandoMensagem.estilo.cor = '#e50914';
                loadingMessage.id = 'uploadLoadingMessage';
                document.getElementById('pixModalContent').appendChild(loadingMessage);

                aguardar uploadTask;
                const downloadURL = await storageRef.getDownloadURL();

                aguarde db.collection('comprovantes').add({
                    ID do usuário: ID do usuário,
                    nome de usuário: nome de usuário,
                    nomedoarquivo: nomedoarquivo,
                    fileURL: URL de download,
                    status: 'pendente', // 'pendente', 'confirmado', 'rejeitado'
                    carimbo de data/hora: firebase.firestore.FieldValue.serverTimestamp()
                });

                document.getElementById('uploadLoadingMessage').remove();
                alert('Comprovante enviado com sucesso! Aguarde a confirmação do administrador.');
                closePixModal();
                logAdminAction('Upload de Comprovante', `Usuário ${userName} (UID: ${userId.substring(0, 5)}...) invejoso comprovante para análise.`);

            } pegar (erro) {
                console.error("Erro ao fazer upload do comprovante: ", erro);
                alert('Erro ao enviar comprovante. Verifique o console para mais detalhes.');
                const loadingMessage = document.getElementById('uploadLoadingMessage');
                se (carregandoMensagem) carregandoMensagem.remover();
            }
        }

        // --- Funções do Modal de Administração ---
        adminPanelBtn.addEventListener('clique', () => {
            se (checkAdminStatus()) {
                adminModal.style.display = 'flex';
                openAdminTab(null, 'gerenciar produtos'); // Abre a primeira aba por padrão
            } outro {
                alert('Acesso negado. Você não tem permissões de administrador.');
            }
        });

        função closeAdminModal() {
            adminModal.style.display = 'nenhum';
        }

        // Botão de Logout
        logoutBtn.addEventListener('clique', () => {
            if (confirm('Tem certeza que deseja sair?')) {
                localStorage.removeItem(LS_IS_ADMIN_KEY);
                localStorage.removeItem(LS_LOGGED_USER_KEY);
                alert('Sessão encerrada. Redirecionando para o login.');
                janela.localização.href = 'index.html';
            }
        });

        window.addEventListener('clique', função(evento) {
            se (evento.alvo == document.getElementById('pixModal')) {
                closePixModal();
            }
            se (evento.target == document.getElementById('adminModal')) {
                closeAdminModal();
            }
        });

        // --- Funções de Gerenciamento de Produtos (Firestore) ---

        db.collection('produtos').onSnapshot((instantâneo) => {
            const produtos = [];
            instantâneo.forEach(doc => {
                produtos.push({ id: doc.id, ...doc.data() });
            });
            renderProducts(produtos);
            loadAdminProducts(produtos);
        }, (erro) => {
            console.error("Erro ao obter produtos: ", erro);
            productsContainer.innerHTML = '<p style="text-align: center; color: #f00;">Erro ao carregar produtos. Verifique sua conexão ou as regras do Firebase.</p>';
        });

        função renderProducts(produtos) {
            produtosContainer.innerHTML = '';
            const isAdmin = checkAdminStatus();

            se (produtos.comprimento === 0) {
                productsContainer.innerHTML = '<p style="text-align: center; color: #ccc; padding: 20px;">Nenhum produto disponível no momento.</p>';
                se (éAdmin) {
                    productsContainer.innerHTML += '<p style="text-align: center; color: #0f0;">Como administrador, você pode adicionar produtos através do "Painel de Administração".</p>';
                }
                retornar;
            }

            produtos.paraCada((produto) => {
                const productDiv = document.createElement('div');
                productDiv.className = 'produto-item';
                const adminButtons = isAdmin ? `
                    <button class="btn-edit-produto" onclick="editProduct('${product.id}')">Editar</button>
                    <button class="btn-delete-produto" onclick="deleteProduct('${product.id}')">Apagar</button>
                ` : '';

                productDiv.innerHTML = `
                    ${adminButtons}
                    <span class="tag">Em destaque</span>
                    <h1 class="produto-titulo">${product.title}</h1>
                    <p class="produto-desc">${product.description}</p>
                    <div class="precos">
                        ${product.oldPrice && product.oldPrice > 0 ? `<span class="preco-antigo">R$ ${parseFloat(product.oldPrice).toFixed(2).replace('.', ',')}</span>` : ''}
                        <span class="preco-atual">R$ ${parseFloat(product.newPrice).toFixed(2).replace('.', ',')}</span>
                    </div>
                    <button class="btn-comprar">Comprar agora</button>
                `;
                produtosContainer.appendChild(produtoDiv);
            });

            // Atualizar para a nova função comprarAgora
            document.querySelectorAll('.btn-comprar').forEach(button => {
                button.removeEventListener('click', comprarAgora); //Remover ouvintes antigos se houver
                button.addEventListener('click', comprarAgora);
            });
        }

        função loadAdminProducts(produtos) {
            if (!checkAdminStatus()) retornar;

            adminProductsList.innerHTML = '';
            se (produtos.comprimento === 0) {
                adminProductsList.innerHTML = '<p style="text-align: center; color: #ccc;">Nenhum produto adicionado ainda.</p>';
                retornar;
            }

            produtos.paraCada(produto => {
                const productItem = document.createElement('div');
                productItem.className = 'admin-product-item';
                productItem.innerHTML = `
                    <span>${product.title} - R$ ${parseFloat(product.newPrice).toFixed(2).replace('.', ',')}</span>
                    <div>
                        <button onclick="editProduct('${product.id}')">Editar</button>
                        <button onclick="deleteProduct('${product.id}')">Apagar</button>
                    </div>
                `;
                adminProductsList.appendChild(produtoItem);
            });
        }

        função assíncrona saveProduct() {
            se (!checkAdminStatus()) {
                alert('Acesso negado.');
                retornar;
            }
            const productId = document.getElementById('productIdToEdit').value;
            const título = document.getElementById('productTitle').value;
            const descrição = document.getElementById('productDesc').value;
            const oldPrice = parseFloat(document.getElementById('productOldPrice').value || 0);
            const novoPrice = parseFloat(document.getElementById('productNewPrice').value);

            if (!title || isNaN(newPrice)) {
                alert('Título e Preço Atual são obrigatórios e o preço deve ser um número.');
                retornar;
            }

            const productData = { título, descrição, preçoantigo, preçonovo };

            tentar {
                se (IDdoproduto) {
                    aguarde db.collection('produtos').doc(productId).update(productData);
                    alert('Produto atualizado com sucesso!');
                    logAdminAction('Atualizar Produto', `Admin ${getCurrentAdminUsername()} atualizou o produto "${title}".`);
                } outro {
                    aguarde db.collection('produtos').add(productData);
                    alert('Produto adicionado com sucesso!');
                    logAdminAction('Criar Produto', `Admin ${getCurrentAdminUsername()} criou o produto "${title}".`);
                }
                clearProductForm();
            } pegar (e) {
                console.error("Erro ao salvar produto: ", e);
                alert("Erro ao salvar o produto. Verifique suas regras do Firestore e conexão.");
            }
        }

        função assíncrona editProduct(id) {
            se (!checkAdminStatus()) {
                alert('Acesso negado.');
                retornar;
            }
            tentar {
                const doc = await db.collection('produtos').doc(id).get();
                se (doc.existe) {
                    const produto = doc.data();
                    documento.getElementById('productIdToEdit').valor = id;
                    document.getElementById('productTitle').value = produto.título;
                    document.getElementById('productDesc').value = produto.descrição;
                    document.getElementById('productOldPrice').value = produto.oldPrice;
                    document.getElementById('productNewPrice').value = produto.newPrice;
                    openAdminTab(null, 'gerenciar produtos'); // Garantir que a aba de produtos esteja ativa
                    adminModal.style.display = 'flex'; // Abre o modal
                } outro {
                    alert('Produto não encontrado.');
                }
            } pegar (e) {
                console.error("Erro ao carregar produto para edição: ", e);
                alert("Erro ao carregar produto para edição.");
            }
        }

        função assíncrona deleteProduct(id) {
            se (!checkAdminStatus()) {
                alert('Acesso negado.');
                retornar;
            }
            if (confirm('Tem certeza que deseja excluir este produto?')) {
                tentar {
                    const productDoc = await db.collection('produtos').doc(id).get();
                    const productName = productDoc.exists? productDoc.data().title : 'Produto Desconhecido';
                    aguarde db.collection('produtos').doc(id).delete();
                    alert('Produto desativado com sucesso!');
                    logAdminAction('Excluir Produto', `Admin ${getCurrentAdminUsername()} pagou o produto "${productName}".`);
                } pegar (e) {
                    console.error("Erro ao desligar produto: ", e);
                    alert("Erro ao desligar o produto. Verifique suas regras do Firestore e conexão.");
                }
            }
        }

        função clearProductForm() {
            documento.getElementById('productIdToEdit').valor = '';
            documento.getElementById('productTitle').valor = '';
            documento.getElementById('productDesc').valor = '';
            document.getElementById('produtoPreçoAntigo').valor = '';
            documento.getElementById('produtoNovoPreço').valor = '';
        }

        // --- Funções de Gerenciamento de Avisos (Firestore) ---

        db.collection('avisos').onSnapshot((instantâneo) => {
            avisos constantes = [];
            instantâneo.forEach(doc => {
                avisos.push({ id: doc.id, ...doc.data() });
            });
            renderWarnings(avisos);
            loadAdminWarnings(avisos);
        }, (erro) => {
            console.error("Erro ao obter avisos: ", erro);
            warningsContainer.innerHTML = '<p style="text-align: center; color: #f00;">Erro ao enviar avisos. Verifique sua conexão ou as regras do Firebase.</p>';
        });

        função renderWarnings(avisos) {
            avisosContainer.innerHTML = '';
            se (avisos.comprimento === 0) {
                avisosContainer.innerHTML = ''; // Não exibe mensagem se não houver avisos
                retornar;
            }
            avisos.paraCada(aviso => ​​{
                const warningDiv = document.createElement('div');
                warningDiv.className = 'mensagem de aviso do administrador';
                warningDiv.textContent = aviso.message;
                avisosContainer.appendChild(warningDiv);
            });
        }

        função loadAdminWarnings(avisos) {
            if (!checkAdminStatus()) retornar;

            adminWarningsList.innerHTML = '';
            se (avisos.comprimento === 0) {
                adminWarningsList.innerHTML = '<p style="text-align: center; color: #ccc;">Nenhum aviso adicionado ainda.</p>';
                retornar;
            }
            avisos.paraCada(aviso => ​​{
                const warningItem = document.createElement('div');
                warningItem.className = 'item de aviso';
                warningItem.innerHTML = `
                    <span>${warning.message}</span>
                    <button onclick="deleteWarning('${warning.id}')" style="background-color: #cc0000;">Apagar</button>
                `;
                adminWarningsList.appendChild(item de aviso);
            });
        }

        função assíncrona addWarning() {
            se (!checkAdminStatus()) {
                alert('Acesso negado.');
                retornar;
            }
            const mensagem = document.getElementById('warningMessage').value;
            se (!mensagem) {
                alert('A mensagem de aviso não pode ser vazia.');
                retornar;
            }
            tentar {
                aguarde db.collection('warnings').add({ mensagem });
                alert('Aviso adicionado com sucesso!');
                logAdminAction('Adicionar Aviso', `Admin ${getCurrentAdminUsername()} adicionou o aviso: "${message.substring(0, 50)}...".`);
                documento.getElementById('warningMessage').valor = '';
            } pegar (e) {
                console.error("Erro ao adicionar aviso: ", e);
                alert("Erro ao adicionar aviso. Verifique suas regras do Firestore e conexão.");
            }
        }

        função assíncrona deleteWarning(id) {
            se (!checkAdminStatus()) {
                alert('Acesso negado.');
                retornar;
            }
            if (confirm('Tem certeza que deseja apagar este aviso?')) {
                tentar {
                    const warningDoc = await db.collection('warnings').doc(id).get();
                    const warningMessage = warningDoc.exists ? warningDoc.data().message : 'Aviso Desconhecido';
                    aguarde db.collection('warnings').doc(id).delete();
                    alert('Aviso apagado com sucesso!');
                    logAdminAction('Deletar Aviso', `Admin ${getCurrentAdminUsername()} pagou o aviso: "${warningMessage.substring(0, 50)}...".`);
                } pegar (e) {
                    console.error("Erro ao apagar aviso: ", e);
                    alert("Erro ao desligar aviso. Verifique suas regras do Firestore e conexão.");
                }
            }
        }

        // --- Funções de Gerenciamento da Chave PIX (Firestore) ---

        db.collection('pixKey').doc('mainPix').onSnapshot((doc) => {
            se (doc.existe) {
                const pixData = doc.data();
                pixChaveDisplay.textContent = pixData.key || 'Nenhuma chave PIX configurada.';
                if (checkAdminStatus()) { // Atualiza o campo no painel de admin apenas se for admin
                    currentPixKeyDisplay.valor = pixData.chave || '';
                }
            } outro {
                pixChaveDisplay.textContent = 'Nenhuma chave PIX configurada.';
                se (checkAdminStatus()) {
                    currentPixKeyDisplay.valor = '';
                }
            }
        }, (erro) => {
            console.error("Erro ao obter chave PIX: ", erro);
            pixChaveDisplay.textContent = 'Erro ao carregar chave PIX.';
        });

        função assíncrona updatePixKey() {
            se (!checkAdminStatus()) {
                alert('Acesso negado.');
                retornar;
            }
            const novaChave = novoPixKeyInput.valor;
            se (!novaChave) {
                alert('A nova chave PIX não pode ser vazia.');
                retornar;
            }
            tentar {
                aguarde db.collection('pixKey').doc('mainPix').set({ chave: newKey }, { mesclar: true });
                alert('Chave PIX atualizada com sucesso!');
                logAdminAction('Atualizar Chave PIX', `Admin ${getCurrentAdminUsername()} atualizou a chave PIX para: "${newKey}".`);
                newPixKeyInput.valor = '';
            } pegar (e) {
                console.error("Erro ao atualizar chave PIX: ", e);
                alert("Erro ao atualizar chave PIX. Verifique suas regras do Firestore e conexão.");
            }
        }

        // --- Funções de Gerenciamento de Pagamentos (Painel Administrativo) ---

        db.collection('comprovantes').where('status', '==', 'pendente').onSnapshot((snapshot) => {
            const pendingPayments = [];
            instantâneo.forEach(doc => {
                pendingPayments.push({ id: doc.id, ...doc.data() });
            });
            renderPendingPayments(pagamentos pendentes);
        }, (erro) => {
            console.error("Erro ao obter comprovantes pendentes: ", error);
            pendentePaymentsList.innerHTML = '<p style="text-align: center; color: #f00;">Erro ao carregar pagamentos pendentes.</p>';
        });

        db.collection('comprovantes').where('status', 'in', ['confirmado', 'rejeitado']).orderBy('timestamp', 'desc').limit(10).onSnapshot((snapshot) => {
            const ProcessosPagamentos = [];
            instantâneo.forEach(doc => {
                processedPayments.push({ id: doc.id, ...doc.data() });
            });
            renderProcessedPayments(processadosPagamentos);
        }, (erro) => {
            console.error("Erro ao obter comprovantes processados: ", erro);
            processedPaymentsList.innerHTML = '<p style="text-align: center; color: #f00;">Erro ao carregar histórico de pagamentos.</p>';
        });


        função renderPendingPayments(pagamentos) {
            if (!checkAdminStatus()) retornar;

            pendingPaymentsList.innerHTML = '';
            se (pagamentos.length === 0) {
                pendentePaymentsList.innerHTML = '<p style="text-align: center; color: #ccc;">Nenhum comprovante pendente no momento.</p>';
                retornar;
            }

            pagamentos.forEach(pagamento => {
                const paymentItem = document.createElement('div');
                paymentItem.className = 'admin-product-item';
                paymentItem.style.backgroundColor = '#333';
                paymentItem.style.border = '1px sólido #e50914';

                const timestampDate = pagamento.timestamp ? pagamento.timestamp.toDate().toLocaleString() : 'N/D';

                paymentItem.innerHTML = `
                    <período>
                        <strong>Usuário:</strong> ${payment.userName} (ID: ${payment.userId.substring(0, 5)}...)<br>
                        <strong>Comprovante:</strong> <a href="${payment.fileURL}" target="_blank" style="color: #007bff;">Ver Arquivo</a><br>
                        <strong>Dados:</strong> ${timestampDate}
                    </span>
                    <div>
                        <button onclick="confirmPayment('${payment.id}')" style="background-color: #0f0;">Confirmar</button>
                        <button onclick="rejectPayment('${payment.id}')" style="background-color: #cc0000;">Rejeitar</button>
                    </div>
                `;
                pendingPaymentsList.appendChild(item de pagamento);
            });
        }

        função renderProcessedPayments(pagamentos) {
            if (!checkAdminStatus()) retornar;

            processedPaymentsList.innerHTML = '';
            se (pagamentos.length === 0) {
                processadoPaymentsList.innerHTML = '<p style="text-align: center; color: #ccc;">Nenhum pagamento processado ainda.</p>';
                retornar;
            }

            pagamentos.forEach(pagamento => {
                const paymentItem = document.createElement('div');
                paymentItem.className = 'admin-product-item';
                paymentItem.style.backgroundColor = payment.status === 'confirmado' ? '#224422' : '#442222';
                paymentItem.style.border = payment.status === 'confirmado' ? '1px solid #0f0' : '1px solid #f00';

                const timestampDate = pagamento.timestamp ? pagamento.timestamp.toDate().toLocaleString() : 'N/D';
                const statusColor = payment.status === 'confirmado' ? '#0f0' : '#f00';

                paymentItem.innerHTML = `
                    <período>
                        <strong>Usuário:</strong> ${payment.userName} (ID: ${payment.userId.substring(0, 5)}...)<br>
                        <strong>Comprovante:</strong> <a href="${payment.fileURL}" target="_blank" style="color: #007bff;">Ver Arquivo</a><br>
                        <strong>Dados:</strong> ${timestampDate}<br>
                        <strong>Status:</strong> <span style="color: ${statusColor}; font-weight: bold;">${payment.status.toUpperCase()}</span>
                    </span>
                `;
                processedPaymentsList.appendChild(item de pagamento);
            });
        }


        função assíncrona confirmPayment(paymentId) {
            se (!checkAdminStatus()) {
                alert('Acesso negado.');
                retornar;
            }
            if (confirm('Tem certeza que deseja confirmar este pagamento?')) {
                tentar {
                    aguarde db.collection('comprovantes').doc(paymentId).update({ status: 'confirmado' });
                    alert('Pagamento confirmado com sucesso!');
                    logAdminAction('Confirmação de Pagamento', `Admin ${getCurrentAdminUsername()} confirmado o pagamento ${paymentId}.`);
                } pegar (e) {
                    console.error("Erro ao confirmar pagamento: ", e);
                    alert("Erro ao confirmar pagamento.");
                }
            }
        }

        função assíncrona rejectPayment(paymentId) {
            se (!checkAdminStatus()) {
                alert('Acesso negado.');
                retornar;
            }
            if (confirm('Tem certeza que deseja rejeitar este pagamento?')) {
                tentar {
                    await db.collection('comprovantes').doc(paymentId).update({ status: 'rejeitado' });
                    alert('Pagamento rejeitado com sucesso!');
                    logAdminAction('Rejeição de Pagamento', `Admin ${getCurrentAdminUsername()} rejeitou o pagamento ${paymentId}.`);
                } pegar (e) {
                    console.error("Erro ao rejeitar pagamento: ", e);
                    alert("Erro ao rejeitar pagamento.");
                }
            }
        }

        // --- Sistema de Logs de Administradores ---

        db.collection('logs').orderBy('timestamp', 'desc').limit(50).onSnapshot((instantâneo) => {
            constantes logs = [];
            instantâneo.forEach(doc => {
                logs.push({ id: doc.id, ...doc.data() });
            });
            renderLogs(registros);
        }, (erro) => {
            console.error("Erro ao obter logs: ", erro);
            logsList.innerHTML = '<p style="text-align: center; color: #f00;">Erro ao carregar logs.</p>';
        });

        função renderLogs(logs) {
            if (!checkAdminStatus()) retornar;

            logsList.innerHTML = '';
            se (logs.length === 0) {
                logsList.innerHTML = '<p style="text-align: center; color: #ccc;">Nenhum log de atividade ainda.</p>';
                retornar;
            }

            logs.forEach(log => {
                const logItem = document.createElement('div');
                logItem.style.marginBottom = '8px';
                logItem.style.paddingBottom = '8px';
                logItem.style.borderBottom = '1px pontilhado #444';
                logItem.style.fontSize = '14px';
                logItem.style.color = '#bbb';

                const timestampDate = log.timestamp ? log.timestamp.toDate().toLocaleString() : 'N/D';

                logItem.innerHTML = `
                    <span style="color: #0f0; font-weight: bold;">[${timestampDate}]</span>
                    <span style="color: #eee;"> ${log.actionType}:</span>
                    <span style="color: #aaa;"> ${log.description}</span>
                `;
                logsList.appendChild(logItem);
            });
        }

        função assíncrona logAdminAction(actionType, descrição) {
            se (!checkAdminStatus()) {
                console.warn('Tentativa de log de ação de admin por não-admin.');
                retornar;
            }
            const currentUser = localStorage.getItem(LS_LOGGED_USER_KEY);
            const adminId = currentUser ? JSON.parse(currentUser).uid : 'desconhecido';
            const adminUsername = currentUser ? JSON.parse(currentUser).username : 'Administrador desconhecido';

            tentar {
                aguarde db.collection('logs').add({
                    ID do administrador: ID do administrador,
                    Nome de usuário do administrador: Nome de usuário do administrador,
                    Tipo de ação: Tipo de ação,
                    descrição: descrição,
                    carimbo de data/hora: firebase.firestore.FieldValue.serverTimestamp()
                });
            } pegar (e) {
                console.error("Erro ao log do registrador: ", e);
            }
        }

        função getCurrentAdminUsername() {
            const currentUser = localStorage.getItem(LS_LOGGED_USER_KEY);
            retornar usuário atual? JSON.parse(currentUser).username : 'Admin Desconhecido';
        }

        // --- Funções de Abas do Painel de Administração ---
        função openAdminTab(evt, tabName) {
            const tabContent = document.querySelectorAll('.admin-tab-content');
            tabContent.forEach(tab => tab.style.display = 'nenhum');

            const tabButtons = document.querySelectorAll('.admin-tab-button');
            tabButtons.forEach(btn => btn.classList.remove('ativo'));

            document.getElementById(tabName).style.display = 'bloco';
            se (evt) {
                evt.currentTarget.classList.add('ativo');
            } outro {
                const defaultButton = document.querySelector(`.admin-tab-button[onclick*="${tabName}"]`);
                se (defaultButton) defaultButton.classList.add('ativo');
            }
        }

    </script>
</corpo>
</html>