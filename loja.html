<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>LOJA HAX</title>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <style>
        /* Reset e base */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Arial, sans-serif; background-color: #0c0c0c; color: #fff; line-height: 1.6; }

        /* Cabeçalho */
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: #111;
            padding: 15px 20px;
            border-bottom: 2px solid #e50914;
        }

        .logo { color: #e50914; font-size: 22px; font-weight: bold; }

        .header-buttons {
            display: flex;
            gap: 10px; /* Espaçamento entre os botões */
        }

        .discord-btn, .admin-panel-btn, .logout-btn {
            background: transparent;
            border: 2px solid #e50914;
            color: #e50914;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            transition: 0.3s;
        }

        .discord-btn:hover, .admin-panel-btn:hover, .logout-btn:hover {
            background-color: #e50914;
            color: white;
        }

        /* Banner */
        .banner {
            height: 250px;
            background: url('') center center no-repeat; /* Imagem do banner */
            background-size: cover;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
        }

        .banner h2 {
            background-color: rgba(0, 0, 0, 0.6);
            border: 2px solid #e50914;
            color: #e50914;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 24px;
            font-weight: bold;
        }

        /* Conteúdo principal */
        .content {
            padding: 30px 20px;
            max-width: 900px;
            margin: 0 auto;
        }

        /* Tag de destaque */
        .tag {
            display: inline-block;
            background-color: #e50914;
            color: white;
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 12px;
            text-transform: uppercase;
            margin-bottom: 10px;
        }

        /* Item do produto */
        .product-item {
            background-color: #1a1a1a;
            border: 1px solid #222;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 8px;
            position: relative;
        }

        .product-title { font-size: 28px; font-weight: bold; margin: 10px 0; color: #e50914;}
        .product-desc { color: #ccc; margin-bottom: 15px; }

        .prices { margin-bottom: 15px; }
        .old-price { text-decoration: line-through; color: #888; font-size: 16px; margin-right: 10px; }
        .current-price { color: #0f0; font-size: 28px; font-weight: bold; } /* Preço atual em verde */

        .btn-buy {
            background-color: #e50914;
            color: white;
            border: none;
            padding: 12px 24px;
            font-size: 16px;
            border-radius: 6px;
            cursor: pointer;
            transition: 0.3s;
        }
        .btn-buy.disabled {
            background-color: #555;
            cursor: not-allowed;
            opacity: 0.7;
        }

        .btn-buy:hover:not(.disabled) {
            background-color: #b20710;
        }

        /* Botões de Admin no produto (só aparecem para admin) */
        .btn-delete-product {
            background-color: #cc0000;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 12px;
            transition: 0.2s;
        }
        .btn-delete-product:hover { background-color: #990000; }

        .btn-edit-product {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            position: absolute;
            top: 10px;
            right: 70px; /* Ajuste para não sobrepor o delete */
            font-size: 12px;
            transition: 0.2s;
        }
        .btn-edit-product:hover { background-color: #0056b3; }


        /* Rodapé */
        footer {
            background-color: #111;
            text-align: center;
            padding: 15px;
            color: #777;
            margin-top: 40px;
            font-size: 14px;
        }

        /* Base de modais */
        .modal {
            display: none; /* Escondido por padrão */
            position: fixed;
            z-index: 1000;
            left: 0; top: 0;
            width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            justify-content: center;
            align-items: center;
            overflow: auto; /* Para modais altos em telas pequenas */
        }

        .modal-content {
            background-color: #111;
            padding: 25px;
            border-radius: 10px;
            text-align: center;
            width: 90%;
            max-width: 450px; /* Largura padrão */
            border: 2px solid #e50914; /* Borda vermelha para modal de compra */
            position: relative;
            animation: fadeIn 0.3s ease-out;
        }

        .modal-content.admin-modal {
            max-width: 700px; /* Mais largo para o painel de administração */
            border: 2px solid #0f0; /* Borda verde para o modal admin */
        }

        .modal-content h3 {
            color: #e50914;
            margin-bottom: 20px;
            font-size: 24px;
        }
        .modal-content.admin-modal h3 {
            color: #0f0; /* Título do modal admin verde */
        }

        .pix-key {
            background-color: #222;
            padding: 12px;
            border-radius: 6px;
            font-size: 16px;
            word-wrap: break-word; /* Quebra texto longo */
            margin-bottom: 20px;
            border: 1px solid #e50914;
        }

        .btn-confirm {
            background-color: #e50914;
            border: none;
            color: white;
            padding: 12px 25px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            transition: 0.3s;
            margin-top: 10px;
        }
        .btn-confirm:hover { background-color: #b20710; }

        .final-message {
            margin-top: 25px;
            color: #0f0;
            font-weight: bold;
            font-size: 18px;
            display: none;
        }

        .close-button {
            position: absolute;
            top: 10px;
            right: 20px;
            color: #aaa;
            font-size: 30px;
            font-weight: bold;
            cursor: pointer;
            transition: 0.2s;
        }
        .close-button:hover, .close-button:focus {
            color: #fff;
        }

        /* Estilos de Administração (dentro do modal) */
        .admin-tab-content h4 {
            color: #eee;
            margin-top: 25px;
            margin-bottom: 15px;
            font-size: 20px;
            border-bottom: 1px solid #333;
            padding-bottom: 5px;
        }

        .admin-section input[type="text"],
        .admin-section input[type="number"],
        .admin-section textarea {
            width: calc(100% - 20px);
            padding: 10px;
            margin-bottom: 10px;
            background-color: #222;
            border: 1px solid #333;
            color: #fff;
            border-radius: 4px;
            font-size: 15px;
        }

        .admin-section button {
            background-color: #0f0; /* Botão verde */
            color: #111;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin-right: 10px;
            transition: 0.3s;
            font-size: 15px;
        }

        .admin-section button:hover {
            background-color: #00cc00;
        }

        .admin-products-list, .admin-warnings-list, #pending-payments-list, #processed-payments-list, #logs-list {
            margin-top: 20px;
            max-height: 250px; /* Limite de altura para rolagem */
            overflow-y: auto; /* Adiciona barra de rolagem se necessário */
            padding-right: 10px; /* Espaço para a barra de rolagem */
            border-top: 1px solid #333;
            padding-top: 15px;
        }
        
        /* Estilos específicos para a lista de links de estoque */
        .stock-links-list {
            max-height: 150px;
            overflow-y: auto;
            border: 1px solid #444;
            background-color: #1a1a1a;
            padding: 10px;
            border-radius: 4px;
            margin-top: 10px;
            color: #ccc;
        }
        .stock-links-list div {
            padding: 5px 0;
            border-bottom: 1px solid #333;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .stock-links-list div:last-child {
            border-bottom: none;
        }
        .stock-links-list button {
            background-color: #dc3545;
            color: white;
            border: none;
            padding: 3px 8px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
            margin-left: 10px;
        }
        .stock-links-list button:hover {
            background-color: #c82333;
        }


        .admin-product-item, .warning-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: #222;
            padding: 12px;
            border-radius: 5px;
            margin-bottom: 10px;
            border: 1px solid #333;
        }

        .admin-product-item span, .warning-item span {
            flex-grow: 1;
            text-align: left;
            font-size: 15px;
        }

        .admin-product-item button, .warning-item button {
            margin-left: 10px;
            padding: 5px 10px;
            font-size: 13px;
            flex-shrink: 0;
        }

        .admin-warning-message {
            background-color: #e50914;
            color: white;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 20px;
            text-align: center;
            font-weight: bold;
            font-size: 16px;
        }

        /* Estilos para as abas de administração */
        .admin-tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid #0f0;
            overflow-x: auto; /* Permite rolagem horizontal se muitas abas */
        }

        .admin-tab-button {
            background-color: #333;
            color: #0f0;
            padding: 10px 15px;
            border: none;
            cursor: pointer;
            border-top-left-radius: 8px;
            border-top-right-radius: 8px;
            margin-right: 5px;
            transition: background-color 0.3s, color 0.3s;
            flex-shrink: 0; /* Evita que os botões encolham */
        }

        .admin-tab-button.active {
            background-color: #0f0;
            color: #111;
        }

        .admin-tab-content {
            display: none;
            text-align: left;
            padding-top: 15px; /* Espaço após as abas */
        }

        .admin-tab-content.active {
            display: block;
        }

        /* Animação para modal */
        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }

        /* Estilos para lista de pagamentos */
        .payment-item {
            background-color: #222;
            padding: 12px;
            border-radius: 5px;
            margin-bottom: 10px;
            border: 1px solid #333;
            display: flex;
            flex-direction: column;
            gap: 5px;
            text-align: left;
        }
        .payment-item div {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .payment-item .status {
            font-weight: bold;
        }
        .payment-item .status.pending { color: #ffc107; } /* Amarelo */
        .payment-item .status.accepted { color: #28a745; } /* Verde */
        .payment-item .status.rejected { color: #dc3545; } /* Vermelho */

        .payment-item .actions button {
            margin-left: 10px;
            padding: 5px 10px;
            font-size: 13px;
        }

    </style>
</head>
<body>

    <header>
        <div class="logo">LOJA HAX</div>
        <div class="header-buttons">
            <button class="discord-btn" onclick="window.open('https://discord.gg/gJ79TUn6Bb', '_blank')">Entrar no Discord</button>
            <button id="adminPanelBtn" class="admin-panel-btn" style="display: none;">Painel de Administração</button>
            <button id="logoutBtn" class="logout-btn" style="display: none;">Sair</button>
        </div>
    </header>

    <div class="banner">
        <h2>Bem-vindo à HAX STORE!</h2>
    </div>

    <div class="content">
        <div id="warnings-container"></div>
        <div id="products-container"></div>
    </div>

    <footer>
        &copy; LOJA HAX 2025. Todos os direitos reservados.
    </footer>

    <div class="modal" id="pixModal">
        <div class="modal-content" id="pixModalContent">
            <span class="close-button" onclick="closePixModal()">×</span>
            <h3>Pagamento via PIX</h3>
            <p>Escaneie o QR Code ou use a chave PIX abaixo:</p>
            <div class="pix-key" id="pixChave"></div>
            
            <button class="btn-confirm" onclick="confirmarPagamentoSolicitar()">Já realizei o pagamento (Solicitar Confirmação)</button>
            <div class="final-message" id="mensagemFinal">Sua solicitação de pagamento foi enviada! Aguarde a confirmação do administrador.</div>
        </div>
    </div>

    <div class="modal" id="adminModal">
        <div class="modal-content admin-modal">
            <span class="close-button" onclick="closeAdminModal()">×</span>
            <h3>Painel de Administração</h3>

            <div class="admin-tabs">
                <button class="admin-tab-button active" onclick="openAdminTab(event, 'manage-products')">Gerenciar Produtos</button>
                <button class="admin-tab-button" onclick="openAdminTab(event, 'manage-warnings')">Gerenciar Avisos</button>
                <button class="admin-tab-button" onclick="openAdminTab(event, 'manage-pix')">Configurar PIX</button>
                <button class="admin-tab-button" onclick="openAdminTab(event, 'manage-payments')">Gerenciar Pagamentos</button>
                <button class="admin-tab-button" onclick="openAdminTab(event, 'admin-logs')">Registros de Atividade</button>
            </div>

            <div id="manage-products" class="admin-tab-content admin-section active">
                <h4>Adicionar/Editar Produto</h4>
                <input type="hidden" id="productIdToEdit">
                <input type="text" id="productTitle" placeholder="Título do Produto" required>
                <textarea id="productDesc" placeholder="Descrição do Produto" rows="3"></textarea>
                <input type="number" id="productOldPrice" placeholder="Preço Antigo (Ex: 30.00)" step="0.01">
                <input type="number" id="productNewPrice" placeholder="Preço Atual (Ex: 10.00)" step="0.01" required>
                <input type="text" id="productStockLinkInput" placeholder="Adicionar link de estoque (um por vez)">
                <button onclick="addStockLink()">Adicionar Link</button>
                <div id="productStockLinksList" class="stock-links-list"></div>
                <button onclick="saveProduct()">Salvar Produto</button>
                <button onclick="clearProductForm()">Limpar Formulário</button>

                <h4>Produtos Existentes</h4>
                <div id="admin-products-list"></div>
            </div>

            <div id="manage-warnings" class="admin-tab-content admin-section">
                <h4>Gerenciar Avisos</h4>
                <input type="text" id="warningMessage" placeholder="Nova mensagem de aviso">
                <button onclick="addWarning()">Adicionar Aviso</button>
                <div id="admin-warnings-list"></div>
            </div>

            <div id="manage-pix" class="admin-tab-content admin-section">
                <h4>Chave PIX Atual</h4>
                <input type="text" id="currentPixKey" placeholder="Chave PIX atual" readonly>
                <h4>Nova Chave PIX</h4>
                <input type="text" id="newPixKey" placeholder="Nova Chave PIX">
                <button onclick="updatePixKey()">Salvar Chave PIX</button>
            </div>

            <div id="manage-payments" class="admin-tab-content admin-section">
                <h4>Solicitações de Pagamento Pendentes</h4>
                <div id="pending-payments-list">
                </div>
                <h4>Histórico de Pagamentos Processados</h4>
                <div id="processed-payments-list" style="max-height: 200px; overflow-y: auto;">
                </div>
            </div>

            <div id="admin-logs" class="admin-tab-content admin-section">
                <h4>Registros Recentes</h4>
                <div id="logs-list" style="max-height: 400px; overflow-y: auto; text-align: left;">
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- Configuração do Firebase ---
        // ATENÇÃO: É CRUCIAL que você substitua os valores abaixo pelas SUAS chaves REAIS do seu projeto Firebase.
        // As chaves que você me passou antes (AIzaSyAx5VNBlcPXveA1xawirSjRVWDNaKdNRmc etc.) SÃO APENAS EXEMPLOS.
        // Se você não substituir por suas chaves reais, o site não funcionará.
        const firebaseConfig = {
            apiKey: "SUA_API_KEY_AQUI", // <-- COLOQUE SUA API KEY AQUI
            authDomain: "SEU_AUTH_DOMAIN_AQUI", // <-- COLOQUE SEU AUTH DOMAIN AQUI
            projectId: "SEU_PROJECT_ID_AQUI", // <-- COLOQUE SEU PROJECT ID AQUI
            storageBucket: "SEU_STORAGE_BUCKET_AQUI", // <-- COLOQUE SEU STORAGE BUCKET AQUI
            messagingSenderId: "SEU_MESSAGING_SENDER_ID_AQUI", // <-- COLOQUE SEU MESSAGING SENDER ID AQUI
            appId: "SEU_APP_ID_AQUI", // <-- COLOQUE SEU APP ID AQUI
            measurementId: "SEU_MEASUREMENT_ID_AQUI" // <-- COLOQUE SEU MEASUREMENT ID AQUI (se estiver usando Analytics)
        };

        // Inicializar o Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore(); 

        // --- Referências aos elementos DOM ---
        const productsContainer = document.getElementById('products-container');
        const adminPanelBtn = document.getElementById('adminPanelBtn');
        const logoutBtn = document.getElementById('logoutBtn');
        const adminModal = document.getElementById('adminModal');
        const adminProductsList = document.getElementById('admin-products-list');
        const warningsContainer = document.getElementById('warnings-container');
        const adminWarningsList = document.getElementById('admin-warnings-list');
        const pixChaveDisplay = document.getElementById('pixChave');
        const newPixKeyInput = document.getElementById('newPixKey');
        const currentPixKeyDisplay = document.getElementById('currentPixKey');

        // Novas referências DOM para estoque
        const productStockLinkInput = document.getElementById('productStockLinkInput');
        const productStockLinksList = document.getElementById('productStockLinksList');
        let currentStockLinks = []; // Array temporário para links do produto em edição/criação

        // Novas referências DOM para pagamentos
        const pendingPaymentsList = document.getElementById('pending-payments-list');
        const processedPaymentsList = document.getElementById('processed-payments-list');
        const logsList = document.getElementById('logs-list');

        // --- Chaves para o localStorage (CORRESPONDENDO AO INDEX.HTML) ---
        const LS_IS_ADMIN_KEY = 'isAdmin';
        const LS_LOGGED_USER_KEY = 'loggedInUser';

        function checkAdminStatus() {
            return localStorage.getItem(LS_IS_ADMIN_KEY) === 'true';
        }

        function checkLoggedInStatus() {
            return localStorage.getItem(LS_LOGGED_USER_KEY) !== null;
        }

        function getCurrentAdminUsername() {
            const user = localStorage.getItem(LS_LOGGED_USER_KEY);
            return user ? JSON.parse(user).username : 'Desconhecido';
        }
        
        // --- Funções de Inicialização ---
        document.addEventListener('DOMContentLoaded', () => {
            if (!checkLoggedInStatus()) {
                window.location.href = 'index.html'; // Redireciona para o login se não estiver logado
                return;
            }

            const isAdmin = checkAdminStatus();
            if (isAdmin) {
                adminPanelBtn.style.display = 'block';
                loadAllAdminData(); // Carrega todos os dados administrativos
            } else {
                adminPanelBtn.style.display = 'none';
            }
            logoutBtn.style.display = 'block';
        });

        // --- Funções de Modal de Compra (PIX) ---
        let currentProductBeingBought = null; // Para saber qual produto está sendo comprado

        function buyNow(productId) {
            if (!checkLoggedInStatus()) {
                alert('Você precisa estar logado para realizar uma compra.');
                window.location.href = 'index.html';
                return;
            }
            currentProductBeingBought = productId; // Armazena o ID do produto que está sendo comprado

            document.getElementById('pixModal').style.display = 'flex';
            document.getElementById('mensagemFinal').style.display = "none";
            
            // Carrega a chave PIX atual para exibição
            db.collection('settings').doc('pix').get().then(doc => {
                if (doc.exists) {
                    pixChaveDisplay.textContent = doc.data().key;
                } else {
                    pixChaveDisplay.textContent = 'Chave PIX não configurada.';
                }
            }).catch(error => {
                console.error("Erro ao carregar chave PIX: ", error);
                pixChaveDisplay.textContent = 'Erro ao carregar chave PIX.';
            });
        }

        function closePixModal() {
            document.getElementById('pixModal').style.display = 'none';
            document.getElementById('mensagemFinal').style.display = "none";
            currentProductBeingBought = null; // Limpa o produto selecionado
        }

        async function confirmarPagamentoSolicitar() {
            if (!checkLoggedInStatus() || !currentProductBeingBought) {
                alert('Erro: Produto ou usuário não identificado para a solicitação de pagamento.');
                return;
            }

            const currentUser = localStorage.getItem(LS_LOGGED_USER_KEY);
            const userId = currentUser ? JSON.parse(currentUser).uid : 'anonymous';
            const userName = currentUser ? JSON.parse(currentUser).username : 'Usuário Desconhecido';

            try {
                const productRef = db.collection('products').doc(currentProductBeingBought);
                const productDoc = await productRef.get();

                if (!productDoc.exists) {
                    alert('Erro: Produto não encontrado.');
                    return;
                }

                const productData = productDoc.data();
                const stockLinks = productData.stockLinks || [];

                if (stockLinks.length === 0) {
                    alert('Este produto está fora de estoque no momento.');
                    logAdminAction('Tentativa de Compra (Sem Estoque)', `Usuário ${userName} (UID: ${userId.substring(0, 5)}...) tentou comprar "${productData.title}" mas estava sem estoque.`);
                    closePixModal();
                    return;
                }

                // Cria uma solicitação de pagamento no Firestore
                await db.collection('paymentRequests').add({
                    userId: userId,
                    userName: userName,
                    productId: currentProductBeingBought,
                    productTitle: productData.title,
                    amount: productData.newPrice,
                    status: 'pending', // 'pending', 'accepted', 'rejected'
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });

                document.getElementById('mensagemFinal').style.display = 'block';
                logAdminAction('Solicitação de Pagamento', `Usuário ${userName} (UID: ${userId.substring(0, 5)}...) solicitou pagamento para "${productData.title}".`);

                // Não fecha o modal imediatamente para o usuário ver a mensagem final
                // O usuário pode fechar manualmente ou você pode adicionar um setTimeout
                // setTimeout(closePixModal, 3000); // Exemplo: fechar após 3 segundos
            } catch (error) {
                console.error("Erro ao enviar solicitação de pagamento: ", error);
                alert('Erro ao enviar solicitação de pagamento. Verifique o console para mais detalhes.');
            }
        }

        // --- Funções do Modal de Administração ---
        adminPanelBtn.addEventListener('click', () => {
            if (checkAdminStatus()) {
                adminModal.style.display = 'flex';
                openAdminTab(null, 'manage-products'); // Abre a primeira aba por padrão
                loadAllAdminData(); // Garante que os dados do admin sejam carregados ao abrir o modal
            } else {
                alert('Acesso negado. Você não tem permissões de administrador.');
            }
        });

        function closeAdminModal() {
            adminModal.style.display = 'none';
        }

        // Botão de Logout
        logoutBtn.addEventListener('click', () => {
            if (confirm('Tem certeza que deseja sair?')) {
                localStorage.removeItem(LS_IS_ADMIN_KEY);
                localStorage.removeItem(LS_LOGGED_USER_KEY);
                alert('Sessão encerrada. Redirecionando para o login.');
                window.location.href = 'index.html';
            }
        });

        window.addEventListener('click', function(event) {
            if (event.target == document.getElementById('pixModal')) {
                closePixModal();
            }
            if (event.target == document.getElementById('adminModal')) {
                closeAdminModal();
            }
        });

        // --- Funções de Gerenciamento de Produtos (Firestore) ---

        db.collection('products').onSnapshot((snapshot) => {
            const products = [];
            snapshot.forEach(doc => {
                products.push({ id: doc.id, ...doc.data() });
            });
            renderProducts(products);
            loadAdminProducts(products);
        }, (error) => {
            console.error("Erro ao obter produtos: ", error);
            productsContainer.innerHTML = '<p style="text-align: center; color: #f00;">Erro ao carregar produtos. Verifique sua conexão ou as regras do Firebase.</p>';
        });

        function renderProducts(products) {
            productsContainer.innerHTML = '';
            const isAdmin = checkAdminStatus();

            if (products.length === 0) {
                productsContainer.innerHTML = '<p style="text-align: center; color: #ccc; padding: 20px;">Nenhum produto disponível no momento.</p>';
                if (isAdmin) {
                    productsContainer.innerHTML += '<p style="text-align: center; color: #0f0;">Como administrador, você pode adicionar produtos através do "Painel de Administração".</p>';
                }
                return;
            }

            products.forEach((product) => {
                const productDiv = document.createElement('div');
                productDiv.className = 'product-item';
                const adminButtons = isAdmin ? `
                    <button class="btn-edit-product" onclick="editProduct('${product.id}')">Editar</button>
                    <button class="btn-delete-product" onclick="deleteProduct('${product.id}')">Apagar</button>
                ` : '';

                const stockCount = product.stockLinks ? product.stockLinks.length : 0;
                const outOfStock = stockCount === 0;
                const buyButtonClass = `btn-buy ${outOfStock ? 'disabled' : ''}`;
                const buyButtonText = outOfStock ? 'Esgotado' : 'Comprar agora';

                productDiv.innerHTML = `
                    ${adminButtons}
                    <span class="tag">Em destaque</span>
                    <h1 class="product-title">${product.title}</h1>
                    <p class="product-desc">${product.description}</p>
                    <div class="prices">
                        ${product.oldPrice && product.oldPrice > 0 ? `<span class="old-price">R$ ${parseFloat(product.oldPrice).toFixed(2).replace('.', ',')}</span>` : ''}
                        <span class="current-price">R$ ${parseFloat(product.newPrice).toFixed(2).replace('.', ',')}</span>
                    </div>
                    <p style="color: #ccc; font-size: 14px; margin-top: 5px;">Estoque: ${stockCount} unidade(s)</p>
                    <button class="${buyButtonClass}" ${outOfStock ? 'disabled' : ''} onclick="buyNow('${product.id}')">${buyButtonText}</button>
                `;
                productsContainer.appendChild(productDiv);
            });
        }

        function loadAdminProducts(products) {
            if (!checkAdminStatus()) return;

            adminProductsList.innerHTML = '';
            if (products.length === 0) {
                adminProductsList.innerHTML = '<p style="text-align: center; color: #ccc;">Nenhum produto adicionado ainda.</p>';
                return;
            }

            products.forEach(product => {
                const productItem = document.createElement('div');
                productItem.className = 'admin-product-item';
                const stockCount = product.stockLinks ? product.stockLinks.length : 0;
                productItem.innerHTML = `
                    <span>${product.title} - R$ ${parseFloat(product.newPrice).toFixed(2).replace('.', ',')} (Estoque: ${stockCount})</span>
                    <div>
                        <button onclick="editProduct('${product.id}')">Editar</button>
                        <button onclick="deleteProduct('${product.id}')">Apagar</button>
                    </div>
                `;
                adminProductsList.appendChild(productItem);
            });
        }

        function renderStockLinksList() {
            productStockLinksList.innerHTML = '';
            if (currentStockLinks.length === 0) {
                productStockLinksList.innerHTML = '<p style="text-align: center; color: #777;">Nenhum link de estoque adicionado.</p>';
                return;
            }
            currentStockLinks.forEach((link, index) => {
                const div = document.createElement('div');
                div.innerHTML = `
                    <span>Link ${index + 1}: ${link.substring(0, 50)}...</span>
                    <button onclick="removeStockLink(${index})">Remover</button>
                `;
                productStockLinksList.appendChild(div);
            });
        }

        function addStockLink() {
            const link = productStockLinkInput.value.trim();
            if (link) {
                currentStockLinks.push(link);
                productStockLinkInput.value = '';
                renderStockLinksList();
            } else {
                alert('Por favor, insira um link de estoque válido.');
            }
        }

        function removeStockLink(index) {
            currentStockLinks.splice(index, 1);
            renderStockLinksList();
        }

        async function saveProduct() {
            if (!checkAdminStatus()) {
                alert('Acesso negado.');
                return;
            }
            const productId = document.getElementById('productIdToEdit').value;
            const title = document.getElementById('productTitle').value;
            const description = document.getElementById('productDesc').value;
            const oldPrice = parseFloat(document.getElementById('productOldPrice').value || 0);
            const newPrice = parseFloat(document.getElementById('productNewPrice').value);

            if (!title || isNaN(newPrice)) {
                alert('Título e Preço Atual são obrigatórios e o preço deve ser um número.');
                return;
            }

            const productData = { title, description, oldPrice, newPrice, stockLinks: currentStockLinks };

            try {
                if (productId) {
                    await db.collection('products').doc(productId).update(productData);
                    alert('Produto atualizado com sucesso!');
                    logAdminAction('Atualizar Produto', `Admin ${getCurrentAdminUsername()} atualizou o produto "${title}".`);
                } else {
                    await db.collection('products').add(productData);
                    alert('Produto adicionado com sucesso!');
                    logAdminAction('Criar Produto', `Admin ${getCurrentAdminUsername()} criou o produto "${title}".`);
                }
                clearProductForm();
            } catch (e) {
                console.error("Erro ao salvar produto: ", e);
                alert("Erro ao salvar o produto. Verifique suas regras do Firestore e conexão.");
            }
        }

        async function editProduct(id) {
            if (!checkAdminStatus()) {
                alert('Acesso negado.');
                return;
            }
            try {
                const doc = await db.collection('products').doc(id).get();
                if (doc.exists) {
                    const product = doc.data();
                    document.getElementById('productIdToEdit').value = id;
                    document.getElementById('productTitle').value = product.title;
                    document.getElementById('productDesc').value = product.description;
                    document.getElementById('productOldPrice').value = product.oldPrice || '';
                    document.getElementById('productNewPrice').value = product.newPrice;
                    currentStockLinks = product.stockLinks || []; // Carrega os links existentes
                    renderStockLinksList(); // Renderiza os links no campo de edição
                } else {
                    alert('Produto não encontrado para edição.');
                }
            } catch (e) {
                console.error("Erro ao buscar produto para edição: ", e);
                alert("Erro ao carregar produto para edição.");
            }
        }

        async function deleteProduct(id) {
            if (!checkAdminStatus()) {
                alert('Acesso negado.');
                return;
            }
            if (confirm('Tem certeza que deseja apagar este produto?')) {
                try {
                    const productDoc = await db.collection('products').doc(id).get();
                    const productName = productDoc.exists ? productDoc.data().title : 'Produto Desconhecido';

                    await db.collection('products').doc(id).delete();
                    alert('Produto apagado com sucesso!');
                    logAdminAction('Deletar Produto', `Admin ${getCurrentAdminUsername()} apagou o produto "${productName}".`);
                    clearProductForm(); // Limpa o formulário após exclusão
                } catch (e) {
                    console.error("Erro ao apagar produto: ", e);
                    alert("Erro ao apagar o produto. Verifique suas regras do Firestore.");
                }
            }
        }

        function clearProductForm() {
            document.getElementById('productIdToEdit').value = '';
            document.getElementById('productTitle').value = '';
            document.getElementById('productDesc').value = '';
            document.getElementById('productOldPrice').value = '';
            document.getElementById('productNewPrice').value = '';
            productStockLinkInput.value = ''; // Limpa o campo de adicionar link
            currentStockLinks = []; // Limpa os links temporários
            renderStockLinksList(); // Atualiza a lista de links vazia
        }

        // --- Funções de Gerenciamento de Avisos (Firestore) ---
        db.collection('warnings').onSnapshot((snapshot) => {
            const warnings = [];
            snapshot.forEach(doc => {
                warnings.push({ id: doc.id, ...doc.data() });
            });
            renderWarnings(warnings);
            loadAdminWarnings(warnings);
        }, (error) => {
            console.error("Erro ao obter avisos: ", error);
            warningsContainer.innerHTML = '<p style="text-align: center; color: #f00;">Erro ao carregar avisos.</p>';
        });

        function renderWarnings(warnings) {
            warningsContainer.innerHTML = '';
            warnings.forEach(warning => {
                const warningDiv = document.createElement('div');
                warningDiv.className = 'admin-warning-message';
                warningDiv.textContent = warning.message;
                warningsContainer.appendChild(warningDiv);
            });
        }

        function loadAdminWarnings(warnings) {
            if (!checkAdminStatus()) return;

            adminWarningsList.innerHTML = '';
            if (warnings.length === 0) {
                adminWarningsList.innerHTML = '<p style="text-align: center; color: #ccc;">Nenhum aviso adicionado ainda.</p>';
                return;
            }
            warnings.forEach(warning => {
                const warningItem = document.createElement('div');
                warningItem.className = 'warning-item';
                warningItem.innerHTML = `
                    <span>${warning.message}</span>
                    <button onclick="deleteWarning('${warning.id}')">Apagar</button>
                `;
                adminWarningsList.appendChild(warningItem);
            });
        }

        async function addWarning() {
            if (!checkAdminStatus()) {
                alert('Acesso negado.');
                return;
            }
            const message = document.getElementById('warningMessage').value.trim();
            if (message) {
                try {
                    await db.collection('warnings').add({ message });
                    alert('Aviso adicionado com sucesso!');
                    logAdminAction('Adicionar Aviso', `Admin ${getCurrentAdminUsername()} adicionou o aviso: "${message}".`);
                    document.getElementById('warningMessage').value = '';
                } catch (e) {
                    console.error("Erro ao adicionar aviso: ", e);
                    alert("Erro ao adicionar aviso.");
                }
            } else {
                alert('Por favor, insira uma mensagem para o aviso.');
            }
        }

        async function deleteWarning(id) {
            if (!checkAdminStatus()) {
                alert('Acesso negado.');
                return;
            }
            if (confirm('Tem certeza que deseja apagar este aviso?')) {
                try {
                    const warningDoc = await db.collection('warnings').doc(id).get();
                    const warningMessage = warningDoc.exists ? warningDoc.data().message : 'Aviso Desconhecido';

                    await db.collection('warnings').doc(id).delete();
                    alert('Aviso apagado com sucesso!');
                    logAdminAction('Deletar Aviso', `Admin ${getCurrentAdminUsername()} apagou o aviso: "${warningMessage}".`);
                } catch (e) {
                    console.error("Erro ao apagar aviso: ", e);
                    alert("Erro ao apagar aviso.");
                }
            }
        }

        // --- Funções de Configuração PIX (Firestore) ---
        db.collection('settings').doc('pix').onSnapshot((doc) => {
            if (doc.exists) {
                const pixData = doc.data();
                currentPixKeyDisplay.value = pixData.key || 'Não configurada';
            } else {
                currentPixKeyDisplay.value = 'Não configurada';
            }
        }, (error) => {
            console.error("Erro ao carregar chave PIX: ", error);
            currentPixKeyDisplay.value = 'Erro ao carregar';
        });

        async function updatePixKey() {
            if (!checkAdminStatus()) {
                alert('Acesso negado.');
                return;
            }
            const newKey = newPixKeyInput.value.trim();
            if (newKey) {
                try {
                    await db.collection('settings').doc('pix').set({ key: newKey });
                    alert('Chave PIX atualizada com sucesso!');
                    logAdminAction('Atualizar Chave PIX', `Admin ${getCurrentAdminUsername()} atualizou a chave PIX.`);
                    newPixKeyInput.value = ''; // Limpa o campo de nova chave
                } catch (e) {
                    console.error("Erro ao atualizar chave PIX: ", e);
                    alert("Erro ao atualizar chave PIX.");
                }
            } else {
                alert('Por favor, insira uma nova chave PIX.');
            }
        }

        // --- Funções de Gerenciamento de Pagamentos (Firestore) ---
        function loadAllAdminData() {
            if (checkAdminStatus()) {
                loadPendingPayments();
                loadProcessedPayments();
                loadAdminLogs();
                // Também garante que produtos e avisos sejam carregados pelo onSnapshot
            }
        }

        db.collection('paymentRequests').onSnapshot((snapshot) => {
            const pending = [];
            const processed = [];
            snapshot.forEach(doc => {
                const data = { id: doc.id, ...doc.data() };
                if (data.status === 'pending') {
                    pending.push(data);
                } else {
                    processed.push(data);
                }
            });
            renderPendingPayments(pending);
            renderProcessedPayments(processed);
        }, (error) => {
            console.error("Erro ao obter solicitações de pagamento: ", error);
        });

        function renderPendingPayments(payments) {
            pendingPaymentsList.innerHTML = '';
            if (payments.length === 0) {
                pendingPaymentsList.innerHTML = '<p style="text-align: center; color: #ccc;">Nenhuma solicitação de pagamento pendente.</p>';
                return;
            }
            payments.sort((a, b) => b.timestamp.toMillis() - a.timestamp.toMillis()); // Mais recentes primeiro
            payments.forEach(payment => {
                const item = document.createElement('div');
                item.className = 'payment-item';
                const date = payment.timestamp ? new Date(payment.timestamp.toDate()).toLocaleString() : 'N/A';
                item.innerHTML = `
                    <div>
                        <strong>Usuário:</strong> <span>${payment.userName}</span>
                    </div>
                    <div>
                        <strong>Produto:</strong> <span>${payment.productTitle}</span>
                    </div>
                    <div>
                        <strong>Valor:</strong> <span>R$ ${parseFloat(payment.amount).toFixed(2).replace('.', ',')}</span>
                    </div>
                    <div>
                        <strong>Data:</strong> <span>${date}</span>
                    </div>
                    <div>
                        <strong>Status:</strong> <span class="status pending">Pendente</span>
                    </div>
                    <div class="actions">
                        <button style="background-color: #28a745;" onclick="processPayment('${payment.id}', 'accepted', '${payment.productId}', '${payment.productTitle}', '${payment.userName}')">Aceitar</button>
                        <button style="background-color: #dc3545;" onclick="processPayment('${payment.id}', 'rejected', '${payment.productId}', '${payment.productTitle}', '${payment.userName}')">Recusar</button>
                    </div>
                `;
                pendingPaymentsList.appendChild(item);
            });
        }

        function renderProcessedPayments(payments) {
            processedPaymentsList.innerHTML = '';
            if (payments.length === 0) {
                processedPaymentsList.innerHTML = '<p style="text-align: center; color: #ccc;">Nenhum pagamento processado ainda.</p>';
                return;
            }
            payments.sort((a, b) => b.timestamp.toMillis() - a.timestamp.toMillis()); // Mais recentes primeiro
            payments.forEach(payment => {
                const item = document.createElement('div');
                item.className = 'payment-item';
                const date = payment.timestamp ? new Date(payment.timestamp.toDate()).toLocaleString() : 'N/A';
                const statusClass = payment.status === 'accepted' ? 'accepted' : 'rejected';
                const statusText = payment.status === 'accepted' ? 'Aceito' : 'Recusado';
                item.innerHTML = `
                    <div>
                        <strong>Usuário:</strong> <span>${payment.userName}</span>
                    </div>
                    <div>
                        <strong>Produto:</strong> <span>${payment.productTitle}</span>
                    </div>
                    <div>
                        <strong>Valor:</strong> <span>R$ ${parseFloat(payment.amount).toFixed(2).replace('.', ',')}</span>
                    </div>
                    <div>
                        <strong>Data:</strong> <span>${date}</span>
                    </div>
                    <div>
                        <strong>Status:</strong> <span class="status ${statusClass}">${statusText}</span>
                    </div>
                `;
                processedPaymentsList.appendChild(item);
            });
        }

        async function processPayment(paymentId, status, productId, productTitle, userName) {
            if (!checkAdminStatus()) {
                alert('Acesso negado.');
                return;
            }

            try {
                // Atualiza o status da solicitação de pagamento
                await db.collection('paymentRequests').doc(paymentId).update({
                    status: status,
                    processedBy: getCurrentAdminUsername(),
                    processedAt: firebase.firestore.FieldValue.serverTimestamp()
                });

                if (status === 'accepted') {
                    // Se aceito, remover 1 link de estoque do produto
                    const productRef = db.collection('products').doc(productId);
                    const productDoc = await productRef.get();

                    if (productDoc.exists) {
                        const productData = productDoc.data();
                        let stockLinks = productData.stockLinks || [];

                        if (stockLinks.length > 0) {
                            const deliveredLink = stockLinks.shift(); // Remove o primeiro link
                            await productRef.update({ stockLinks: stockLinks });

                            // Opcional: Registrar qual link foi entregue para qual usuário
                            await db.collection('deliveredItems').add({
                                userId: productData.userId || 'N/A', // O userId original da solicitação de pagamento
                                userName: userName,
                                productId: productId,
                                productTitle: productTitle,
                                deliveredLink: deliveredLink,
                                deliveredAt: firebase.firestore.FieldValue.serverTimestamp()
                            });
                            alert(`Pagamento aceito para "${productTitle}". Link entregue ao usuário ${userName}.`);
                            logAdminAction('Aceitar Pagamento', `Admin ${getCurrentAdminUsername()} aceitou o pagamento de ${userName} para "${productTitle}" e entregou um link.`);
                        } else {
                            alert(`Pagamento aceito para "${productTitle}", mas o produto não possui links de estoque disponíveis.`);
                            logAdminAction('Aceitar Pagamento (Sem Estoque)', `Admin ${getCurrentAdminUsername()} aceitou o pagamento de ${userName} para "${productTitle}", mas o estoque de links estava vazio.`);
                        }
                    } else {
                        alert('Produto associado ao pagamento não encontrado.');
                    }
                } else {
                    alert(`Pagamento recusado para "${productTitle}".`);
                    logAdminAction('Recusar Pagamento', `Admin ${getCurrentAdminUsername()} recusou o pagamento de ${userName} para "${productTitle}".`);
                }
            } catch (e) {
                console.error("Erro ao processar pagamento: ", e);
                alert("Erro ao processar o pagamento. Verifique as regras do Firestore.");
            }
        }

        // --- Funções de Logs de Atividade (Firestore) ---
        async function logAdminAction(actionType, message) {
            try {
                await db.collection('adminLogs').add({
                    actionType: actionType,
                    message: message,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    adminUser: getCurrentAdminUsername()
                });
            } catch (e) {
                console.error("Erro ao registrar log de administrador: ", e);
            }
        }

        db.collection('adminLogs').orderBy('timestamp', 'desc').limit(50).onSnapshot((snapshot) => {
            const logs = [];
            snapshot.forEach(doc => {
                logs.push(doc.data());
            });
            renderAdminLogs(logs);
        }, (error) => {
            console.error("Erro ao obter logs de administrador: ", error);
        });

        function renderAdminLogs(logs) {
            logsList.innerHTML = '';
            if (logs.length === 0) {
                logsList.innerHTML = '<p style="text-align: center; color: #ccc;">Nenhum registro de atividade recente.</p>';
                return;
            }
            logs.forEach(log => {
                const logItem = document.createElement('div');
                const date = log.timestamp ? new Date(log.timestamp.toDate()).toLocaleString() : 'N/A';
                logItem.style.marginBottom = '5px';
                logItem.style.padding = '5px';
                logItem.style.backgroundColor = '#1f1f1f';
                logItem.style.borderRadius = '3px';
                logItem.style.fontSize = '14px';
                logItem.innerHTML = `
                    <strong style="color: #0f0;">[${log.actionType}]</strong> ${log.message} <br>
                    <span style="color: #888; font-size: 12px;">(${date} por ${log.adminUser})</span>
                `;
                logsList.appendChild(logItem);
            });
        }


        // --- Funções de Navegação de Abas Admin ---
        function openAdminTab(evt, tabName) {
            let i, tabcontent, tablinks;
            tabcontent = document.getElementsByClassName("admin-tab-content");
            for (i = 0; i < tabcontent.length; i++) {
                tabcontent[i].style.display = "none";
            }
            tablinks = document.getElementsByClassName("admin-tab-button");
            for (i = 0; i < tablinks.length; i++) {
                tablinks[i].className = tablinks[i].className.replace(" active", "");
            }
            document.getElementById(tabName).style.display = "block";
            if (evt) {
                evt.currentTarget.className += " active";
            } else {
                // Ativa a primeira aba se chamado sem evento (inicialização)
                document.querySelector(`.admin-tab-button[onclick*="${tabName}"]`).className += " active";
            }
            // Recarrega os dados específicos da aba ao abrir
            if (tabName === 'manage-products') {
                // Produtos já são recarregados pelo onSnapshot
                clearProductForm(); // Garante que o formulário de produto esteja limpo
            } else if (tabName === 'manage-payments') {
                loadPendingPayments();
                loadProcessedPayments();
            } else if (tabName === 'admin-logs') { // Corrigido para 'admin-logs'
                // Os logs já são recarregados pelo onSnapshot, mas a chamada aqui não faz mal
            }
        }
    </script>
</body>
</html>