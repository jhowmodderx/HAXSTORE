<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>LOJA HAX</title>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-storage-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <style>
        /* Redefinir e base */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Arial, sans-serif; background-color: #0c0c0c; color: #fff; line-height: 1.6; }

        /* Cabeçalho */
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: #111;
            padding: 15px 20px;
            border-bottom: 2px solid #e50914;
        }

        .logo { color: #e50914; font-size: 22px; font-weight: bold; }

        .botoes-topo {
            display: flex;
            gap: 10px; /* Espaçamento entre os botões */
        }

        .discord-btn, .admin-panel-btn, .logout-btn {
            background: transparent;
            border: 2px solid #e50914;
            color: #e50914;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            transition: 0.3s;
        }

        .discord-btn:hover, .admin-panel-btn:hover, .logout-btn:hover {
            background-color: #e50914;
            color: white;
        }

        /* Banner */
        .banner {
            height: 250px;
            background: url('') center no-repeat center; /* Imagem do banner */
            background-size: cover;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
        }

        .banner h2 {
            background-color: rgba(0, 0, 0, 0.6);
            border: 2px solid #e50914;
            color: #e50914;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 24px;
            font-weight: bold;
        }

        /* Conteúdo principal */
        .content {
            padding: 30px 20px;
            max-width: 900px;
            margin: 0 auto;
        }

        /* Tag de destaque */
        .tag {
            display: inline-block;
            background-color: #e50914;
            color: white;
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 12px;
            text-transform: uppercase;
            margin-bottom: 10px;
        }

        /* Item do produto */
        .produto-item {
            background-color: #1a1a1a;
            border: 1px solid #222;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 8px;
            position: relative;
        }

        .produto-titulo { font-size: 28px; font-weight: bold; margin: 10px 0; color: #e50914;}
        .produto-desc { color: #ccc; margin-bottom: 15px; }

        .precos { margin-bottom: 15px; }
        .preco-antigo { text-decoration: line-through; color: #888; font-size: 16px; margin-right: 10px; }
        .preco-atual { color: #0f0; font-size: 28px; font-weight: bold; } /* Preço atual em verde */

        .btn-comprar {
            background-color: #e50914;
            color: white;
            border: none;
            padding: 12px 24px;
            font-size: 16px;
            border-radius: 6px;
            cursor: pointer;
            transition: 0.3s;
        }

        .btn-comprar:hover {
            background-color: #b20710;
        }
        .btn-comprar.disabled {
            background-color: #555;
            cursor: not-allowed;
        }
        .btn-comprar.disabled:hover {
            background-color: #555;
        }

        /* Botões de Admin no produto (só aparecem para admin) */
        .btn-delete-produto {
            background-color: #cc0000;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 12px;
            transition: 0.2s;
        }
        .btn-delete-produto:hover { background-color: #990000; }

        .btn-edit-produto {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            position: absolute;
            top: 10px;
            right: 70px; /* Ajuste para não sobrepor ou excluir */
            font-size: 12px;
            transition: 0.2s;
        }
        .btn-edit-produto:hover { background-color: #0056b3; }


        /* Rodapé */
        footer {
            background-color: #111;
            text-align: center;
            padding: 15px;
            color: #777;
            margin-top: 40px;
            font-size: 14px;
        }

        /* Base de modais */
        .modal {
            display: none; /* Escondido por padrão */
            position: fixed;
            z-index: 1000;
            left: 0; top: 0;
            width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            justify-content: center;
            align-items: center;
            overflow: auto; /* Para modais altos em telas pequenas */
        }

        .modal-content {
            background-color: #111;
            padding: 25px;
            border-radius: 10px;
            text-align: center;
            width: 90%;
            max-width: 450px; /* Largura padrão */
            border: 2px solid #e50914; /* Borda vermelha para modal de compra */
            position: relative;
            animation: fadeIn 0.3s ease-in-out;
        }

        .modal-content.admin-modal {
            max-width: 700px; /* Mais largo para o painel de administração */
            border: 2px solid #0f0; /* Borda verde para o modal admin */
        }

        .modal-content h3 {
            color: #e50914;
            margin-bottom: 20px;
            font-size: 24px;
        }
        .modal-content.admin-modal h3 {
            color: #0f0; /* Título do modal admin verde */
        }

        .pix-key-display {
            background-color: #222;
            padding: 12px;
            border-radius: 6px;
            font-size: 16px;
            word-break: break-word; /* Quebra texto longo */
            margin-bottom: 20px;
            border: 1px solid #e50914;
        }

        .btn-confirmar {
            background-color: #e50914;
            border: none;
            color: white;
            padding: 12px 25px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            transition: 0.3s;
            margin-top: 10px; /* Margem adicionada para o botão de upload */
        }
        .btn-confirmar:hover { background-color: #b20710; }

        .mensagem-final {
            margin-top: 25px;
            color: #0f0;
            font-weight: bold;
            font-size: 18px;
            display: none;
        }

        .close-button {
            position: absolute;
            top: 10px;
            right: 20px;
            color: #aaa;
            font-size: 30px;
            font-weight: bold;
            cursor: pointer;
            transition: 0.2s;
        }
        .close-button:hover, .close-button:focus {
            color: #fff;
        }

        /* Estilos de Administração (dentro do modal) */
        .admin-tab-content h4 {
            color: #eee;
            margin-top: 25px;
            margin-bottom: 15px;
            font-size: 20px;
            border-bottom: 1px solid #333;
            padding-bottom: 5px;
        }

        .admin-section input[type="text"],
        .admin-section input[type="number"],
        .admin-section textarea {
            width: calc(100% - 20px);
            padding: 10px;
            margin-bottom: 10px;
            background-color: #222;
            border: 1px solid #333;
            color: #fff;
            border-radius: 4px;
            font-size: 15px;
        }

        .admin-section button {
            background-color: #0f0; /* Botão verde */
            color: #111;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin-right: 10px;
            transition: 0.3s;
            font-size: 15px;
        }

        .admin-section button:hover {
            background-color: #00cc00;
        }

        .admin-product-list, .admin-warnings-list, #pending-payments-list, #processed-payments-list, #logs-list {
            margin-top: 20px;
            max-height: 250px; /* Limite de altura para rolagem */
            overflow-y: auto; /* Adiciona barra de rolagem se necessário */
            padding-right: 10px; /* Espaço para a barra de rolagem */
            border-top: 1px solid #333;
            padding-top: 15px;
        }

        .admin-product-item, .warning-item, .payment-item, .log-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: #222;
            padding: 12px;
            border-radius: 5px;
            margin-bottom: 10px;
            border: 1px solid #333;
        }

        .admin-product-item span, .warning-item span, .payment-item span, .log-item span {
            flex-grow: 1;
            text-align: left;
            font-size: 15px;
        }

        .admin-product-item button, .warning-item button, .payment-item button {
            margin-left: 10px;
            padding: 5px 10px;
            font-size: 13px;
            flex-shrink: 0;
        }

        .admin-warning-message {
            background-color: #e50914;
            color: white;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 20px;
            text-align: center;
            font-weight: bold;
            font-size: 16px;
        }

        /* Estilos para as abas de administração */
        .admin-tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid #0f0;
            overflow-x: auto; /* Permite rolagem horizontal se muitas abas */
        }

        .admin-tab-button {
            background-color: #333;
            color: #0f0;
            padding: 10px 15px;
            border: none;
            cursor: pointer;
            border-top-left-radius: 8px;
            border-top-right-radius: 8px;
            margin-right: 5px;
            transition: background-color 0.3s, color 0.3s;
            flex-shrink: 0; /* Evita que os botões encolham */
        }

        .admin-tab-button.active {
            background-color: #0f0;
            color: #111;
        }

        .admin-tab-content {
            display: none;
            text-align: left;
            padding-top: 15px; /* Espaço após as abas */
        }

        .admin-tab-content.active {
            display: block;
        }

        /* Animação para modal */
        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }
    </style>
</head>
<body>

    <header>
        <div class="logo">HAX STORE</div>
        <div class="botoes-topo">
            <button class="discord-btn" onclick="window.open('https://discord.gg/gJ79TUn6Bb', '_blank')">Entrar no Discord</button>
            <button id="adminPanelBtn" class="admin-panel-btn" style="display: none;">Painel de Administração</button>
            <button id="logoutBtn" class="logout-btn" style="display: none;">Sair</button>
        </div>
    </header>

    <div class="banner">
        <h2>Bem-vindo à HAX STORE!</h2>
    </div>

    <main class="content">
        <section id="warnings-container"></section>
        <section id="produtos-container"></section>
    </main>

    <footer>
        &copy; LOJA HAX 2025. Todos os direitos reservados.
    </footer>

    <div class="modal" id="pixModal">
        <div class="modal-content" id="pixModalContent">
            <span class="close-button" onclick="closePixModal()">×</span>
            <h3>Pagamento via PIX</h3>
            <p>Escaneie o QR Code ou use a chave PIX abaixo:</p>
            <div class="pix-key-display" id="pixKeyDisplay">Carregando chave PIX...</div>
            <button class="btn-confirmar" onclick="copyPixKey()">Copiar Chave PIX</button>
            
            <div style="margin-top: 20px; border-top: 1px solid #333; padding-top: 15px;">
                <h4>Anexar Comprovante</h4>
                <input type="file" id="comprovanteFile" accept="image/*,application/pdf" style="margin-bottom: 10px; color: #fff;">
                <button class="btn-confirmar" onclick="uploadComprovante()">Enviar Comprovante</button>
            </div>

            <p class="mensagem-final" id="mensagemFinal">HAX STORE - ENVIE O COMPROVANTE NO TICKET DO DISCORD!</p>
        </div>
    </div>

    <div class="modal" id="adminModal">
        <div class="modal-content admin-modal">
            <span class="close-button" onclick="closeAdminModal()">×</span>
            <h3>Painel de Administração</h3>

            <div class="admin-tabs">
                <button class="admin-tab-button active" onclick="openAdminTab(event, 'manage-products')">Gerenciar Produtos</button>
                <button class="admin-tab-button" onclick="openAdminTab(event, 'manage-warnings')">Gerenciar Avisos</button>
                <button class="admin-tab-button" onclick="openAdminTab(event, 'manage-pix')">Configurar PIX</button>
                <button class="admin-tab-button" onclick="openAdminTab(event, 'manage-payments')">Gerenciar Pagamentos</button>
                <button class="admin-tab-button" onclick="openAdminTab(event, 'admin-logs')">Registros de Atividade</button>
            </div>

            <div id="manage-products" class="admin-tab-content active admin-section">
                <h4>Adicionar/Editar Produto</h4>
                <input type="hidden" id="productIdToEdit">
                <input type="text" id="productTitle" placeholder="Título do Produto" required>
                <textarea id="productDesc" placeholder="Descrição do Produto" rows="3"></textarea>
                <input type="number" id="productOldPrice" placeholder="Preço Antigo (Ex: 30.00)" step="0.01">
                <input type="number" id="productNewPrice" placeholder="Preço Atual (Ex: 10.00)" step="0.01" required>
                <textarea id="productLinks" placeholder="Links do Produto (um por linha)&#10;Ex: link1.com/produtoX&#10;link2.com/produtoX" rows="5"></textarea>
                <button onclick="saveProduct()">Salvar Produto</button>
                <button onclick="clearProductForm()">Limpar Formulário</button>

                <h4>Produtos Existentes</h4>
                <div id="admin-products-list"></div>
            </div>

            <div id="manage-warnings" class="admin-tab-content admin-section">
                <h4>Gerenciar Avisos</h4>
                <input type="text" id="warningMessage" placeholder="Nova mensagem de aviso">
                <button onclick="addWarning()">Adicionar Aviso</button>
                <div id="admin-warnings-list"></div>
            </div>

            <div id="manage-pix" class="admin-tab-content admin-section">
                <h4>Chave PIX Atual</h4>
                <input type="text" id="currentPixKey" placeholder="Chave PIX atual" readonly>
                <h4>Nova Chave PIX</h4>
                <input type="text" id="newPixKey" placeholder="Nova Chave PIX">
                <button onclick="updatePixKey()">Salvar Chave PIX</button>
            </div>

            <div id="manage-payments" class="admin-tab-content admin-section">
                <h4>Solicitações de Pagamento Pendentes</h4>
                <div id="pending-payments-list"></div>
                <h4>Histórico de Pagamentos Confirmados/Rejeitados</h4>
                <div id="processed-payments-list" style="max-height: 200px; overflow-y: auto;"></div>
            </div>

            <div id="admin-logs" class="admin-tab-content admin-section">
                <h4>Registros Recentes</h4>
                <div id="logs-list" style="max-height: 400px; overflow-y: auto; text-align: left;"></div>
            </div>
        </div>
    </div>

    <script>
        // --- Configuração do Firebase ---
        // ATENÇÃO: Verifique se estas são suas chaves corretas!
        const firebaseConfig = {
            apiKey: "AIzaSyAx5VNBlcPXveA1xawirSjRVWDNaKdNRmc", /* cite: 2 */
            authDomain: "haxstore-a250a.firebaseapp.com", /* cite: 2 */
            projectId: "haxstore-a250a", /* cite: 2 */
            storageBucket: "haxstore-a250a.appspot.com", /* cite: 2 */
            messagingSenderId: "39538757064", /* cite: 2 */
            appId: "1:39538757064:web:7f45d2cba626b6333ac4fd", /* cite: 2 */
            measurementId: "G-3D42M9L1HF" /* cite: 2 */
        };

        // Inicializar o Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore(); /* cite: 2 */
        const storage = firebase.storage(); /* cite: 2 */
        const auth = firebase.auth();

        // --- Referências aos elementos DOM ---
        const productsContainer = document.getElementById('produtos-container'); /* cite: 2 */
        const adminPanelBtn = document.getElementById('adminPanelBtn'); /* cite: 2 */
        const logoutBtn = document.getElementById('logoutBtn'); /* cite: 2 */
        const adminModal = document.getElementById('adminModal'); /* cite: 2 */
        const adminProductsList = document.getElementById('admin-products-list'); /* cite: 2 */
        const warningsContainer = document.getElementById('warnings-container'); /* cite: 2 */
        const adminWarningsList = document.getElementById('admin-warnings-list'); /* cite: 2 */
        const pixKeyDisplay = document.getElementById('pixKeyDisplay');
        const newPixKeyInput = document.getElementById('newPixKey'); /* cite: 2 */
        const currentPixKeyDisplay = document.getElementById('currentPixKey'); /* cite: 2 */

        // Novas referências DOM
        const comprovanteFileInput = document.getElementById('comprovanteFile'); /* cite: 2 */
        const pendingPaymentsList = document.getElementById('pending-payments-list');
        const processedPaymentsList = document.getElementById('processed-payments-list');
        const logsList = document.getElementById('logs-list'); /* cite: 2 */

        let currentBuyingProductId = null; // Variável global para armazenar o ID do produto sendo comprado

        // --- Chaves para o localStorage (CORRESPONDENDO AO INDEX.HTML) ---
        // Estas chaves devem ser as mesmas usadas no seu arquivo index.html
        const LS_IS_ADMIN_KEY = 'isAdmin'; /* cite: 2 */
        const LS_LOGGED_USER_KEY = 'loggedUser'; /* cite: 2 */

        function checkAdminStatus() {
            return localStorage.getItem(LS_IS_ADMIN_KEY) === 'true'; /* cite: 2 */
        }

        function checkLoggedInStatus() {
            return localStorage.getItem(LS_LOGGED_USER_KEY) !== null; /* cite: 2 */
        }

        // --- Funções de Inicialização ---
        document.addEventListener('DOMContentLoaded', () => {
            if (!checkLoggedInStatus()) {
                window.location.href = 'index.html'; // Redireciona para o login se não estiver logado
                return;
            }

            const isAdmin = checkAdminStatus();
            if (isAdmin) {
                adminPanelBtn.style.display = 'block'; /* cite: 2 */
            } else {
                adminPanelBtn.style.display = 'none'; /* cite: 2 */
            }
            logoutBtn.style.display = 'block'; /* cite: 2 */
        });

        // --- Funções de Modal de Compra (PIX) ---
        async function buyNow(productId) {
            if (!checkLoggedInStatus()) {
                alert('Você precisa estar logado para realizar uma compra.');
                window.location.href = 'index.html';
                return;
            }
            currentBuyingProductId = productId; // Armazena o ID do produto
            document.getElementById('pixModal').style.display = 'flex';
            document.getElementById('mensagemFinal').style.display = "none";
            comprovanteFileInput.value = ''; // Limpa a entrada do arquivo
        }

        function closePixModal() {
            document.getElementById('pixModal').style.display = 'none'; /* cite: 2 */
            document.getElementById('mensagemFinal').style.display = "none"; /* cite: 2 */
        }

        function copyPixKey() {
            const pixKey = pixKeyDisplay.textContent;
            navigator.clipboard.writeText(pixKey).then(() => {
                alert('Chave PIX copiada!');
            }).catch(err => {
                console.error('Erro ao copiar a chave PIX: ', err);
                alert('Erro ao copiar a chave PIX.');
            });
        }

        // --- Funções de Upload de Comprovante ---
        async function uploadComprovante() {
            if (!checkLoggedInStatus()) {
                alert('Você precisa estar logado para enviar um comprovante.');
                return;
            }

            const file = comprovanteFileInput.files[0]; /* cite: 2 */
            if (!file) {
                alert('Por favor, selecione um arquivo de comprovante.');
                return;
            }

            if (!currentBuyingProductId) {
                alert('Erro: Produto não identificado para esta compra.');
                return;
            }

            const currentUser = localStorage.getItem(LS_LOGGED_USER_KEY); /* cite: 2 */
            const userId = currentUser ? JSON.parse(currentUser).uid : 'anonymous'; /* cite: 2 */
            const userName = currentUser ? JSON.parse(currentUser).username : 'Usuário Desconhecido'; /* cite: 2 */

            const productDoc = await db.collection('produtos').doc(currentBuyingProductId).get();
            const productTitle = productDoc.exists ? productDoc.data().title : 'Produto Desconhecido';

            const fileName = `${Date.now()}_${file.name}`; /* cite: 2 */
            const storageRef = storage.ref(`comprovantes/${userId}/${fileName}`); /* cite: 2 */
            const uploadTask = storageRef.put(file); /* cite: 2 */

            try {
                const loadingMessage = document.createElement('p');
                loadingMessage.textContent = 'Enviando comprovante...';
                loadingMessage.style.color = '#e50914';
                loadingMessage.id = 'uploadLoadingMessage';
                document.getElementById('pixModalContent').appendChild(loadingMessage);

                await uploadTask; /* cite: 2 */
                const downloadURL = await storageRef.getDownloadURL(); /* cite: 2 */

                await db.collection('comprovantes').add({ /* cite: 2 */
                    userId: userId, /* cite: 2 */
                    userName: userName, /* cite: 2 */
                    productId: currentBuyingProductId,
                    productTitle: productTitle,
                    fileName: fileName, /* cite: 2 */
                    fileURL: downloadURL, /* cite: 2 */
                    status: 'pendente', // 'pendente', 'confirmado', 'rejeitado' /* cite: 2 */
                    timestamp: firebase.firestore.FieldValue.serverTimestamp() /* cite: 2 */
                });

                document.getElementById('uploadLoadingMessage').remove();
                alert('Comprovante enviado com sucesso! Aguarde a confirmação do administrador.');
                closePixModal();
                logAdminAction('Upload de Comprovante', `Usuário ${userName} (UID: ${userId.substring(0, 5)}...) enviou comprovante para "${productTitle}".`);
                currentBuyingProductId = null; // Limpa o ID do produto armazenado

            } catch (error) {
                console.error("Erro ao fazer upload do comprovante: ", error); /* cite: 2 */
                alert('Erro ao enviar comprovante. Verifique o console para mais detalhes.'); /* cite: 2 */
                const loadingMessage = document.getElementById('uploadLoadingMessage');
                if (loadingMessage) loadingMessage.remove();
            }
        }

        // --- Funções do Modal de Administração ---
        adminPanelBtn.addEventListener('click', async () => {
            if (checkAdminStatus()) {
                adminModal.style.display = 'flex';
                // Verifica pagamentos pendentes e abre a aba apropriada
                try {
                    const pendingSnapshot = await db.collection('comprovantes').where('status', '==', 'pendente').get();
                    if (pendingSnapshot.empty) {
                        openAdminTab(null, 'manage-products'); // Padrão para produtos se não houver pendentes
                    } else {
                        openAdminTab(null, 'manage-payments'); // Vai para pagamentos se houver pendentes
                    }
                } catch (error) {
                    console.error("Erro ao verificar pagamentos pendentes para abertura do admin panel: ", error);
                    openAdminTab(null, 'manage-products'); // Fallback
                }
            } else {
                alert('Acesso negado. Você não tem permissões de administrador.');
            }
        });

        function closeAdminModal() {
            adminModal.style.display = 'none'; /* cite: 2 */
            clearProductForm(); // Limpa o formulário ao fechar
        }

        // Botão de Logout
        logoutBtn.addEventListener('click', () => {
            if (confirm('Tem certeza que deseja sair?')) {
                auth.signOut().then(() => {
                    localStorage.removeItem(LS_IS_ADMIN_KEY);
                    localStorage.removeItem(LS_LOGGED_USER_KEY);
                    alert('Sessão encerrada. Redirecionando para o login.');
                    window.location.href = 'index.html';
                }).catch((error) => {
                    console.error("Erro ao fazer logout:", error);
                    alert('Erro ao fazer logout. Tente novamente.');
                });
            }
        });

        window.addEventListener('click', function(event) {
            if (event.target == document.getElementById('pixModal')) {
                closePixModal();
            }
            if (event.target == document.getElementById('adminModal')) {
                closeAdminModal();
            }
        });

        // --- Funções de Gerenciamento de Produtos (Firestore) ---

        db.collection('produtos').onSnapshot((snapshot) => {
            const produtos = [];
            snapshot.forEach(doc => {
                produtos.push({ id: doc.id, ...doc.data() });
            });
            renderProducts(produtos);
            loadAdminProducts(produtos);
        }, (error) => {
            console.error("Erro ao obter produtos: ", error); /* cite: 2 */
            productsContainer.innerHTML = '<p style="text-align: center; color: #f00;">Erro ao carregar produtos. Verifique sua conexão ou as regras do Firebase.</p>'; /* cite: 2 */
        });

        function renderProducts(produtos) {
            productsContainer.innerHTML = ''; /* cite: 2 */
            const isAdmin = checkAdminStatus(); /* cite: 2 */

            if (produtos.length === 0) {
                productsContainer.innerHTML = '<p style="text-align: center; color: #ccc; padding: 20px;">Nenhum produto disponível no momento.</p>'; /* cite: 2 */
                if (isAdmin) {
                    productsContainer.innerHTML += '<p style="text-align: center; color: #0f0;">Como administrador, você pode adicionar produtos através do "Painel de Administração".</p>'; /* cite: 2 */
                }
                return;
            }

            produtos.forEach((product) => {
                const productDiv = document.createElement('div');
                productDiv.className = 'produto-item';
                const adminButtons = isAdmin ? `
                    <button class="btn-edit-produto" onclick="editProduct('${product.id}')">Editar</button>
                    <button class="btn-delete-produto" onclick="deleteProduct('${product.id}')">Apagar</button>
                ` : '';
                
                const hasStock = product.links && product.links.length > 0;
                const buyButtonText = hasStock ? 'Comprar agora' : 'Sem estoque';
                const buyButtonClass = hasStock ? 'btn-comprar' : 'btn-comprar disabled';
                const buyButtonDisabled = hasStock ? '' : 'disabled';

                productDiv.innerHTML = `
                    ${adminButtons}
                    <span class="tag">Em destaque</span>
                    <h1 class="produto-titulo">${product.title}</h1>
                    <p class="produto-desc">${product.description}</p>
                    <div class="precos">
                        ${product.oldPrice && product.oldPrice > 0 ? `<span class="preco-antigo">R$ ${parseFloat(product.oldPrice).toFixed(2).replace('.', ',')}</span>` : ''}
                        <span class="preco-atual">R$ ${parseFloat(product.newPrice).toFixed(2).replace('.', ',')}</span>
                    </div>
                    <button class="${buyButtonClass}" ${buyButtonDisabled} data-product-id="${product.id}">${buyButtonText}</button>
                `;
                productsContainer.appendChild(productDiv);
            });

            document.querySelectorAll('.btn-comprar:not(.disabled)').forEach(button => {
                button.removeEventListener('click', handleBuyClick); // Remove ouvintes antigos se houver
                button.addEventListener('click', handleBuyClick); // Adiciona novo ouvinte
            });
        }

        async function handleBuyClick(event) {
            const productId = event.target.dataset.productId;
            try {
                const productDoc = await db.collection('produtos').doc(productId).get();
                if (productDoc.exists) {
                    const product = productDoc.data();
                    if (product.links && product.links.length > 0) {
                        buyNow(productId); // Abre o modal de compra com o ID do produto
                    } else {
                        alert('Este produto está sem estoque no momento.');
                        loadProducts(); // Recarregar produtos para atualizar o status do botão
                    }
                } else {
                    alert('Produto não encontrado.');
                    loadProducts();
                }
            } catch (error) {
                console.error("Erro ao verificar estoque: ", error);
                alert('Ocorreu um erro ao verificar o estoque.');
            }
        }


        function loadAdminProducts(produtos) {
            if (!checkAdminStatus()) return; /* cite: 2 */

            adminProductsList.innerHTML = ''; /* cite: 2 */
            if (produtos.length === 0) {
                adminProductsList.innerHTML = '<p style="text-align: center; color: #ccc;">Nenhum produto adicionado ainda.</p>'; /* cite: 2 */
                return;
            }

            produtos.forEach(product => {
                const productItem = document.createElement('div');
                productItem.className = 'admin-product-item';
                const stockCount = product.links ? product.links.length : 0; // Exibe a quantidade de links
                productItem.innerHTML = `
                    <span>${product.title} - R$ ${parseFloat(product.newPrice).toFixed(2).replace('.', ',')} (Estoque: ${stockCount} links)</span>
                    <div>
                        <button onclick="editProduct('${product.id}')">Editar</button>
                        <button onclick="deleteProduct('${product.id}')">Apagar</button>
                    </div>
                `;
                adminProductsList.appendChild(productItem);
            });
        }

        async function saveProduct() {
            if (!checkAdminStatus()) {
                alert('Acesso negado.');
                return;
            }
            const productId = document.getElementById('productIdToEdit').value; /* cite: 2 */
            const title = document.getElementById('productTitle').value; /* cite: 2 */
            const description = document.getElementById('productDesc').value; /* cite: 2 */
            const oldPrice = parseFloat(document.getElementById('productOldPrice').value || 0); /* cite: 2 */
            const newPrice = parseFloat(document.getElementById('productNewPrice').value); /* cite: 2 */
            const productLinks = document.getElementById('productLinks').value.split('\n').map(link => link.trim()).filter(link => link !== '');

            if (!title || isNaN(newPrice)) {
                alert('Título e Preço Atual são obrigatórios e o preço deve ser um número.');
                return;
            }

            const productData = { title, description, oldPrice, newPrice, links: productLinks };

            try {
                if (productId) {
                    await db.collection('produtos').doc(productId).update(productData); /* cite: 2 */
                    alert('Produto atualizado com sucesso!'); /* cite: 2 */
                    logAdminAction('Atualizar Produto', `Admin ${getCurrentAdminUsername()} atualizou o produto "${title}".`);
                } else {
                    await db.collection('produtos').add(productData); /* cite: 2 */
                    alert('Produto adicionado com sucesso!'); /* cite: 2 */
                    logAdminAction('Criar Produto', `Admin ${getCurrentAdminUsername()} criou o produto "${title}".`);
                }
                clearProductForm(); /* cite: 2 */
            } catch (e) {
                console.error("Erro ao salvar produto: ", e); /* cite: 2 */
                alert("Erro ao salvar o produto. Verifique suas regras do Firestore e conexão."); /* cite: 2 */
            }
        }

        async function editProduct(id) {
            if (!checkAdminStatus()) {
                alert('Acesso negado.');
                return;
            }
            try {
                const doc = await db.collection('produtos').doc(id).get(); /* cite: 2 */
                if (doc.exists) {
                    const product = doc.data(); /* cite: 2 */
                    document.getElementById('productIdToEdit').value = id; /* cite: 2 */
                    document.getElementById('productTitle').value = product.title; /* cite: 2 */
                    document.getElementById('productDesc').value = product.description; /* cite: 2 */
                    document.getElementById('productOldPrice').value = product.oldPrice; /* cite: 2 */
                    document.getElementById('productNewPrice').value = product.newPrice; /* cite: 2 */
                    document.getElementById('productLinks').value = product.links ? product.links.join('\n') : '';
                    openAdminTab(null, 'manage-products'); // Garantir que a aba de produtos esteja ativa
                    adminModal.style.display = 'flex'; // Abre o modal
                } else {
                    alert('Produto não encontrado.'); /* cite: 2 */
                }
            } catch (e) {
                console.error("Erro ao carregar produto para edição: ", e); /* cite: 2 */
                alert("Erro ao carregar produto para edição."); /* cite: 2 */
            }
        }

        async function deleteProduct(id) {
            if (!checkAdminStatus()) {
                alert('Acesso negado.');
                return;
            }
            if (confirm('Tem certeza que deseja excluir este produto?')) {
                try {
                    const productDoc = await db.collection('produtos').doc(id).get(); /* cite: 2 */
                    const productName = productDoc.exists ? productDoc.data().title : 'Produto Desconhecido';
                    await db.collection('produtos').doc(id).delete(); /* cite: 2 */
                    alert('Produto apagado com sucesso!'); /* cite: 2 */
                    logAdminAction('Excluir Produto', `Admin ${getCurrentAdminUsername()} apagou o produto "${productName}".`);
                } catch (e) {
                    console.error("Erro ao apagar produto: ", e); /* cite: 2 */
                    alert("Erro ao apagar o produto. Verifique suas regras do Firestore e conexão."); /* cite: 2 */
                }
            }
        }

        function clearProductForm() {
            document.getElementById('productIdToEdit').value = ''; /* cite: 2 */
            document.getElementById('productTitle').value = ''; /* cite: 2 */
            document.getElementById('productDesc').value = ''; /* cite: 2 */
            document.getElementById('productOldPrice').value = ''; /* cite: 2 */
            document.getElementById('productNewPrice').value = ''; /* cite: 2 */
            document.getElementById('productLinks').value = '';
        }

        // --- Funções de Gerenciamento de Avisos (Firestore) ---

        db.collection('avisos').onSnapshot((snapshot) => {
            const warnings = [];
            snapshot.forEach(doc => {
                warnings.push({ id: doc.id, ...doc.data() });
            });
            renderWarnings(warnings);
            loadAdminWarnings(warnings);
        }, (error) => {
            console.error("Erro ao obter avisos: ", error); /* cite: 2 */
            warningsContainer.innerHTML = '<p style="text-align: center; color: #f00;">Erro ao carregar avisos. Verifique sua conexão ou as regras do Firebase.</p>'; /* cite: 2 */
        });

        function renderWarnings(warnings) {
            warningsContainer.innerHTML = ''; /* cite: 2 */
            if (warnings.length === 0) {
                warningsContainer.innerHTML = ''; // Não exibe mensagem se não houver avisos
                return;
            }
            warnings.forEach(warning => {
                const warningDiv = document.createElement('div');
                warningDiv.className = 'admin-warning-message';
                warningDiv.textContent = warning.message; /* cite: 2 */
                warningsContainer.appendChild(warningDiv);
            });
        }

        function loadAdminWarnings(warnings) {
            if (!checkAdminStatus()) return; /* cite: 2 */

            adminWarningsList.innerHTML = ''; /* cite: 2 */
            if (warnings.length === 0) {
                adminWarningsList.innerHTML = '<p style="text-align: center; color: #ccc;">Nenhum aviso adicionado ainda.</p>'; /* cite: 2 */
                return;
            }
            warnings.forEach(warning => {
                const warningItem = document.createElement('div');
                warningItem.className = 'warning-item';
                warningItem.innerHTML = `
                    <span>${warning.message}</span>
                    <button onclick="deleteWarning('${warning.id}')" style="background-color: #cc0000;">Apagar</button>
                `;
                adminWarningsList.appendChild(warningItem);
            });
        }

        async function addWarning() {
            if (!checkAdminStatus()) {
                alert('Acesso negado.');
                return;
            }
            const message = document.getElementById('warningMessage').value; /* cite: 2 */
            if (!message) {
                alert('A mensagem de aviso não pode ser vazia.');
                return;
            }
            try {
                await db.collection('avisos').add({ message }); /* cite: 2 */
                alert('Aviso adicionado com sucesso!'); /* cite: 2 */
                logAdminAction('Adicionar Aviso', `Admin ${getCurrentAdminUsername()} adicionou o aviso: "${message.substring(0, 50)}...".`);
                document.getElementById('warningMessage').value = ''; /* cite: 2 */
            } catch (e) {
                console.error("Erro ao adicionar aviso: ", e); /* cite: 2 */
                alert("Erro ao adicionar aviso. Verifique suas regras do Firestore e conexão."); /* cite: 2 */
            }
        }

        async function deleteWarning(id) {
            if (!checkAdminStatus()) {
                alert('Acesso negado.');
                return;
            }
            if (confirm('Tem certeza que deseja apagar este aviso?')) {
                try {
                    const warningDoc = await db.collection('avisos').doc(id).get(); /* cite: 2 */
                    const warningMessage = warningDoc.exists ? warningDoc.data().message : 'Aviso Desconhecido';
                    await db.collection('avisos').doc(id).delete(); /* cite: 2 */
                    alert('Aviso apagado com sucesso!'); /* cite: 2 */
                    logAdminAction('Deletar Aviso', `Admin ${getCurrentAdminUsername()} apagou o aviso: "${warningMessage.substring(0, 50)}...".`);
                } catch (e) {
                    console.error("Erro ao apagar aviso: ", e); /* cite: 2 */
                    alert("Erro ao apagar aviso. Verifique suas regras do Firestore e conexão."); /* cite: 2 */
                }
            }
        }

        // --- Funções de Gerenciamento da Chave PIX (Firestore) ---

        db.collection('pixKey').doc('mainPix').onSnapshot((doc) => {
            if (doc.exists) {
                const pixData = doc.data(); /* cite: 2 */
                pixKeyDisplay.textContent = pixData.key || 'Nenhuma chave PIX configurada.'; /* cite: 2 */
                if (checkAdminStatus()) { // Atualiza o campo no painel de admin apenas se for admin
                    currentPixKeyDisplay.value = pixData.key || ''; /* cite: 2 */
                }
            } else {
                pixKeyDisplay.textContent = 'Nenhuma chave PIX configurada.'; /* cite: 2 */
                if (checkAdminStatus()) {
                    currentPixKeyDisplay.value = ''; /* cite: 2 */
                }
            }
        }, (error) => {
            console.error("Erro ao obter chave PIX: ", error); /* cite: 2 */
            pixKeyDisplay.textContent = 'Erro ao carregar chave PIX.'; /* cite: 2 */
        });

        async function updatePixKey() {
            if (!checkAdminStatus()) {
                alert('Acesso negado.');
                return;
            }
            const newKey = newPixKeyInput.value; /* cite: 2 */
            if (!newKey) {
                alert('A nova chave PIX não pode ser vazia.');
                return;
            }
            try {
                await db.collection('pixKey').doc('mainPix').set({ key: newKey }, { merge: true }); /* cite: 2 */
                alert('Chave PIX atualizada com sucesso!'); /* cite: 2 */
                logAdminAction('Atualizar Chave PIX', `Admin ${getCurrentAdminUsername()} atualizou a chave PIX para: "${newKey}".`);
                newPixKeyInput.value = ''; /* cite: 2 */
            } catch (e) {
                console.error("Erro ao atualizar chave PIX: ", e); /* cite: 2 */
                alert("Erro ao atualizar chave PIX. Verifique suas regras do Firestore e conexão."); /* cite: 2 */
            }
        }

        // --- Funções de Gerenciamento de Pagamentos (Painel Administrativo) ---

        db.collection('comprovantes').where('status', '==', 'pendente').onSnapshot((snapshot) => {
            const pendingPayments = [];
            snapshot.forEach(doc => {
                pendingPayments.push({ id: doc.id, ...doc.data() });
            });
            renderPendingPayments(pendingPayments);
        }, (error) => {
            console.error("Erro ao obter comprovantes pendentes: ", error); /* cite: 2 */
            pendingPaymentsList.innerHTML = '<p style="text-align: center; color: #f00;">Erro ao carregar pagamentos pendentes.</p>'; /* cite: 2 */
        });

        db.collection('comprovantes').where('status', 'in', ['confirmado', 'rejeitado']).orderBy('timestamp', 'desc').limit(10).onSnapshot((snapshot) => {
            const processedPayments = [];
            snapshot.forEach(doc => {
                processedPayments.push({ id: doc.id, ...doc.data() });
            });
            renderProcessedPayments(processedPayments);
        }, (error) => {
            console.error("Erro ao obter comprovantes processados: ", error); /* cite: 2 */
            processedPaymentsList.innerHTML = '<p style="text-align: center; color: #f00;">Erro ao carregar histórico de pagamentos.</p>'; /* cite: 2 */
        });


        function renderPendingPayments(payments) {
            if (!checkAdminStatus()) return; /* cite: 2 */

            pendingPaymentsList.innerHTML = ''; /* cite: 2 */
            if (payments.length === 0) {
                pendingPaymentsList.innerHTML = '<p style="text-align: center; color: #ccc;">Nenhum comprovante pendente no momento.</p>'; /* cite: 2 */
                return;
            }

            payments.forEach(payment => {
                const paymentItem = document.createElement('div');
                paymentItem.className = 'payment-item';
                paymentItem.style.backgroundColor = '#333';
                paymentItem.style.border = '1px solid #e50914';

                const timestampDate = payment.timestamp ? payment.timestamp.toDate().toLocaleString() : 'N/D';
                const productTitleHtml = payment.productTitle ? `<br><strong>Produto:</strong> ${payment.productTitle}` : '';

                paymentItem.innerHTML = `
                    <span>
                        <strong>Usuário:</strong> ${payment.userName} (ID: ${payment.userId.substring(0, 5)}...) ${productTitleHtml}<br>
                        <strong>Comprovante:</strong> <a href="${payment.fileURL}" target="_blank" style="color: #007bff;">Ver Arquivo</a><br>
                        <strong>Data:</strong> ${timestampDate}
                    </span>
                    <div>
                        <button onclick="confirmPayment('${payment.id}')" style="background-color: #0f0;">Confirmar</button>
                        <button onclick="rejectPayment('${payment.id}')" style="background-color: #cc0000;">Rejeitar</button>
                    </div>
                `;
                pendingPaymentsList.appendChild(paymentItem);
            });
        }

        function renderProcessedPayments(payments) {
            if (!checkAdminStatus()) return; /* cite: 2 */

            processedPaymentsList.innerHTML = ''; /* cite: 2 */
            if (payments.length === 0) {
                processedPaymentsList.innerHTML = '<p style="text-align: center; color: #ccc;">Nenhum pagamento processado ainda.</p>'; /* cite: 2 */
                return;
            }

            payments.forEach(payment => {
                const paymentItem = document.createElement('div');
                paymentItem.className = 'payment-item';
                paymentItem.style.backgroundColor = payment.status === 'confirmado' ? '#224422' : '#442222';
                paymentItem.style.border = payment.status === 'confirmado' ? '1px solid #0f0' : '1px solid #f00';

                const timestampDate = payment.timestamp ? payment.timestamp.toDate().toLocaleString() : 'N/D';
                const statusColor = payment.status === 'confirmado' ? '#0f0' : '#f00';
                const deliveredLinkHtml = payment.deliveredLink ? `<br><strong>Link Entregue:</strong> <a href="${payment.deliveredLink}" target="_blank" style="color: #007bff;">${payment.deliveredLink}</a>` : '';
                const productTitleHtml = payment.productTitle ? `<br><strong>Produto:</strong> ${payment.productTitle}` : '';

                paymentItem.innerHTML = `
                    <span>
                        <strong>Usuário:</strong> ${payment.userName} (ID: ${payment.userId.substring(0, 5)}...)<br>
                        <strong>Comprovante:</strong> <a href="${payment.fileURL}" target="_blank" style="color: #007bff;">Ver Arquivo</a>${productTitleHtml}<br>
                        <strong>Data:</strong> ${timestampDate}<br>
                        <strong>Status:</strong> <span style="color: ${statusColor}; font-weight: bold;">${payment.status.toUpperCase()}</span>
                        ${deliveredLinkHtml}
                    </span>
                `;
                processedPaymentsList.appendChild(paymentItem);
            });
        }


        async function confirmPayment(paymentId) {
            if (!checkAdminStatus()) {
                alert('Acesso negado.');
                return;
            }
            if (confirm('Tem certeza que deseja confirmar este pagamento e entregar o link do produto?')) {
                try {
                    const paymentDoc = await db.collection('comprovantes').doc(paymentId).get();
                    if (!paymentDoc.exists) {
                        alert('Pagamento não encontrado.');
                        return;
                    }
                    const paymentData = paymentDoc.data();
                    const productId = paymentData.productId;

                    if (!productId) {
                        alert('Erro: ID do produto não encontrado no comprovante de pagamento.');
                        return;
                    }

                    // Usa uma transação Firestore para atomicidade
                    await db.runTransaction(async (transaction) => {
                        const productRef = db.collection('produtos').doc(productId);
                        const productSnapshot = await transaction.get(productRef);

                        if (!productSnapshot.exists) {
                            throw new Error("Produto não encontrado ou foi excluído.");
                        }

                        const product = productSnapshot.data();
                        if (!product.links || product.links.length === 0) {
                            throw new Error("Produto sem estoque para entrega.");
                        }

                        const deliveredLink = product.links.shift(); // Pega e remove o primeiro link
                        transaction.update(productRef, { links: product.links });
                        transaction.update(db.collection('comprovantes').doc(paymentId), {
                            status: 'confirmado',
                            deliveredLink: deliveredLink, // Armazena o link entregue
                            processedBy: getCurrentAdminUsername(),
                            processedAt: firebase.firestore.FieldValue.serverTimestamp()
                        });

                        logAdminAction('Confirmação de Pagamento e Entrega', `Admin ${getCurrentAdminUsername()} confirmou o pagamento ${paymentId} para o produto "${product.title}" e entregou o link: ${deliveredLink}.`);
                    });

                    alert('Pagamento confirmado e link do produto entregue com sucesso!');
                    // As onSnapshots recarregarão as listas automaticamente
                } catch (e) {
                    console.error("Erro ao confirmar pagamento e entregar link: ", e);
                    alert(`Erro: ${e.message}. Verifique se o produto tem estoque.`);
                }
            }
        }

        async function rejectPayment(paymentId) {
            if (!checkAdminStatus()) {
                alert('Acesso negado.');
                return;
            }
            if (confirm('Tem certeza que deseja rejeitar este pagamento?')) {
                try {
                    await db.collection('comprovantes').doc(paymentId).update({
                        status: 'rejeitado',
                        processedBy: getCurrentAdminUsername(),
                        processedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    alert('Pagamento rejeitado com sucesso!');
                    logAdminAction('Rejeição de Pagamento', `Admin ${getCurrentAdminUsername()} rejeitou o pagamento ${paymentId}.`);
                } catch (e) {
                    console.error("Erro ao rejeitar pagamento: ", e); /* cite: 2 */
                    alert("Erro ao rejeitar pagamento."); /* cite: 2 */
                }
            }
        }

        // --- Sistema de Logs de Administradores ---

        db.collection('adminLogs').orderBy('timestamp', 'desc').limit(50).onSnapshot((snapshot) => {
            const logs = [];
            snapshot.forEach(doc => {
                logs.push({ id: doc.id, ...doc.data() });
            });
            renderLogs(logs);
        }, (error) => {
            console.error("Erro ao obter logs: ", error); /* cite: 2 */
            logsList.innerHTML = '<p style="text-align: center; color: #f00;">Erro ao carregar logs.</p>'; /* cite: 2 */
        });

        function renderLogs(logs) {
            if (!checkAdminStatus()) return; /* cite: 2 */

            logsList.innerHTML = ''; /* cite: 2 */
            if (logs.length === 0) {
                logsList.innerHTML = '<p style="text-align: center; color: #ccc;">Nenhum log de atividade ainda.</p>'; /* cite: 2 */
                return;
            }

            logs.forEach(log => {
                const logItem = document.createElement('div');
                logItem.className = 'log-item';
                logItem.style.marginBottom = '8px';
                logItem.style.paddingBottom = '8px';
                logItem.style.borderBottom = '1px dotted #444';
                logItem.style.fontSize = '14px';
                logItem.style.color = '#bbb';

                const timestampDate = log.timestamp ? log.timestamp.toDate().toLocaleString() : 'N/D'; /* cite: 2 */

                logItem.innerHTML = `
                    <span style="color: #0f0; font-weight: bold;">[${timestampDate}]</span>
                    <span style="color: #eee;"> ${log.actionType}:</span>
                    <span style="color: #aaa;"> ${log.description}</span>
                `;
                logsList.appendChild(logItem);
            });
        }

        async function logAdminAction(actionType, description) {
            if (!checkAdminStatus()) {
                console.warn('Tentativa de log de ação de admin por não-admin.');
                return;
            }
            const currentUser = localStorage.getItem(LS_LOGGED_USER_KEY); /* cite: 2 */
            const adminId = currentUser ? JSON.parse(currentUser).uid : 'desconhecido'; /* cite: 2 */
            const adminUsername = currentUser ? JSON.parse(currentUser).username : 'Administrador desconhecido'; /* cite: 2 */

            try {
                await db.collection('adminLogs').add({
                    adminId: adminId, /* cite: 2 */
                    adminUsername: adminUsername, /* cite: 2 */
                    actionType: actionType, /* cite: 2 */
                    description: description, /* cite: 2 */
                    timestamp: firebase.firestore.FieldValue.serverTimestamp() /* cite: 2 */
                });
            } catch (e) {
                console.error("Erro ao registrar log: ", e); /* cite: 2 */
            }
        }

        function getCurrentAdminUsername() {
            const currentUser = localStorage.getItem(LS_LOGGED_USER_KEY); /* cite: 2 */
            return currentUser ? JSON.parse(currentUser).username : 'Admin Desconhecido'; /* cite: 2 */
        }

        // --- Funções de Abas do Painel de Administração ---
        function openAdminTab(evt, tabName) {
            const tabContent = document.querySelectorAll('.admin-tab-content'); /* cite: 2 */
            tabContent.forEach(tab => tab.style.display = 'none'); /* cite: 2 */

            const tabButtons = document.querySelectorAll('.admin-tab-button'); /* cite: 2 */
            tabButtons.forEach(btn => btn.classList.remove('active')); /* cite: 2 */

            document.getElementById(tabName).style.display = 'block'; /* cite: 2 */
            if (evt) {
                evt.currentTarget.classList.add('active'); /* cite: 2 */
            } else {
                const defaultButton = document.querySelector(`.admin-tab-button[onclick*="${tabName}"]`);
                if (defaultButton) defaultButton.classList.add('active');
            }
        }

    </script>
</body>
</html>